<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.team3.admin_mapper.ProductStatusMapper">

    <!-- ===============================
          결과 매핑
    =============================== -->
    <resultMap id="ProductStatusMap" type="kr.co.team3.admin_dto.ProductStatusDTO">
        <result column="P_PID"             property="pid"/>
        <result column="P_NAME"            property="name"/>
        <result column="SALE_PRICE"        property="salePrice"/>
        <result column="P_DISCOUNT"        property="discount"/>
        <result column="P_POINT"           property="point"/>
        <result column="P_STOCK_QUANTITY"  property="stockQty"/>
        <result column="SELLER_NAME"       property="sellerName"/>
        <result column="P_VIEW_COUNT"      property="viewCount"/>
        <result column="IMAGE_URL"         property="imageUrl"/>
    </resultMap>


    <!-- ===============================
          목록 조회 (페이지네이션)
    =============================== -->
    <select id="selectProductStatusPage" resultType="kr.co.team3.admin_dto.ProductStatusDTO">
        SELECT
        pi.P_PID              AS pid,
        pi.P_NAME             AS name,
        pi.P_PRICE            AS salePrice,
        pi.P_DISCOUNT         AS discount,
        pi.P_STOCK_QUANTITY   AS stockQty,
        pi.P_VIEW_COUNT       AS viewCount,
        si.S_COMPANY_NAME     AS sellerName,
        pi.P_IMAGE_MAIN       AS imageUrl
        FROM PRODUCT_ITEM pi
        LEFT JOIN SELLER_INFO si ON si.S_U_ID = pi.P_SELLER_ID

        <where>
            <!--  검색 -->
            <if test="req.searchType != null and req.searchType != '' and req.keyword != null and req.keyword != ''">
                <choose>
                    <when test="req.searchType == 'name'">
                        AND LOWER(pi.P_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                    </when>
                    <when test="req.searchType == 'pid'">
                        AND LOWER(pi.P_PID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                    </when>
                    <when test="req.searchType == 'seller'">
                        AND (
                        LOWER(pi.P_SELLER_ID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(si.S_COMPANY_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        )
                    </when>
                    <otherwise>
                        AND (
                        LOWER(pi.P_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(pi.P_PID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(si.S_COMPANY_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(pi.P_SELLER_ID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        )
                    </otherwise>
                </choose>
            </if>

            <!-- 👤 권한 필터: 관리자 외엔 본인 것만 -->
            <if test="req.userType != null and req.userType != '관리자'">
                AND pi.P_SELLER_ID = #{req.sellerId}
            </if>
        </where>

        ORDER BY pi.P_REGDATE DESC
        OFFSET #{req.offset} ROWS FETCH NEXT #{req.size} ROWS ONLY
    </select>


    <!-- ===============================
          전체 행 수 (count)
    =============================== -->
    <select id="countProductStatus" resultType="int">
        SELECT COUNT(1)
        FROM PRODUCT_ITEM pi
        LEFT JOIN SELLER_INFO si ON si.S_U_ID = pi.P_SELLER_ID

        <where>
            <if test="req.searchType != null and req.searchType != '' and req.keyword != null and req.keyword != ''">
                <choose>
                    <when test="req.searchType == 'name'">
                        AND LOWER(pi.P_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                    </when>
                    <when test="req.searchType == 'pid'">
                        AND LOWER(pi.P_PID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                    </when>
                    <when test="req.searchType == 'seller'">
                        AND (
                        LOWER(pi.P_SELLER_ID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(si.S_COMPANY_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        )
                    </when>
                    <otherwise>
                        AND (
                        LOWER(pi.P_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(pi.P_PID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(si.S_COMPANY_NAME) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        OR LOWER(pi.P_SELLER_ID) LIKE '%' || LOWER(#{req.keyword}) || '%'
                        )
                    </otherwise>
                </choose>
            </if>

            <if test="req.userType != null and req.userType != '관리자'">
                AND pi.P_SELLER_ID = #{req.sellerId}
            </if>
        </where>

    </select>


    <!-- ===============================
          단건 및 다건 삭제
    =============================== -->
    <!-- 개별 삭제 (자식 → 부모 순서) -->
    <delete id="deleteCartItems">      DELETE FROM CART_ITEMS      WHERE CI_P_PID = #{pid} </delete>
    <delete id="deleteCategoryLinks">  DELETE FROM CATEGORY_LINKS  WHERE CL_P_PID = #{pid} </delete>
    <delete id="deleteOrderItems">     DELETE FROM ORDER_ITEMS     WHERE OI_P_PID = #{pid} </delete>
    <delete id="deleteProductDetail">  DELETE FROM PRODUCT_DETAIL  WHERE PD_P_PID = #{pid} </delete>
    <delete id="deleteProductOptions"> DELETE FROM PRODUCT_OPTION  WHERE POP_P_PID = #{pid} </delete>
    <delete id="deleteProductReview">  DELETE FROM PRODUCT_REVIEW  WHERE PR_P_PID = #{pid} </delete>
    <delete id="deleteTagsLinks">      DELETE FROM TAGS_LINKS      WHERE TL_P_PID = #{pid} </delete>
    <delete id="deleteProduct">        DELETE FROM PRODUCT_ITEM    WHERE P_PID    = #{pid} </delete>

    <!-- 선택삭제 (다건) -->
    <delete id="deleteCartItemsBulk" parameterType="list">
        DELETE FROM CART_ITEMS WHERE CI_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteCategoryLinksBulk" parameterType="list">
        DELETE FROM CATEGORY_LINKS WHERE CL_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteOrderItemsBulk" parameterType="list">
        DELETE FROM ORDER_ITEMS WHERE OI_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteProductDetailBulk" parameterType="list">
        DELETE FROM PRODUCT_DETAIL WHERE PD_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteProductOptionsBulk" parameterType="list">
        DELETE FROM PRODUCT_OPTION WHERE POP_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteProductReviewBulk" parameterType="list">
        DELETE FROM PRODUCT_REVIEW WHERE PR_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteTagsLinksBulk" parameterType="list">
        DELETE FROM TAGS_LINKS WHERE TL_P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>
    <delete id="deleteProducts" parameterType="list">
        DELETE FROM PRODUCT_ITEM WHERE P_PID IN
        <foreach collection="pids" item="pid" open="(" separator="," close=")">#{pid}</foreach>
    </delete>

</mapper>
