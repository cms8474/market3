<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.team3.admin_mapper.OrderStatusMapper">

    <!-- 공통 WHERE: searchType, keyword -->
    <sql id="searchWhere">
        <where>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <!-- 주문번호로 검색 (NUMBER → CHAR 변환) -->
                    <when test="searchType == 'po_no'">
                        AND TO_CHAR(po.PO_NO) LIKE '%' || #{keyword} || '%'
                    </when>

                    <!-- 주문자 아이디 -->
                    <when test="searchType == 'u_id'">
                        AND LOWER(po.PO_U_ID) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>

                    <!-- 주문자명 -->
                    <when test="searchType == 'u_name'">
                        AND LOWER(uu.U_NAME) LIKE '%' || LOWER(#{keyword}) || '%'
                    </when>

                    <!-- 기본: 주문자 아이디 -->
                    <otherwise>
                        AND LOWER(po.PO_U_ID) LIKE '%' || LOWER(#{keyword}) || '%'
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>

    <!-- 결과 매핑 -->
    <resultMap id="OrderStatusMap" type="kr.co.team3.admin_dto.OrderStatusDTO">
        <result column="PO_NO"          property="poNo"/>
        <result column="PO_U_ID"        property="poUId"/>
        <result column="U_NAME"         property="uName"/>
        <result column="PO_ITEM_COUNT"  property="itemCount"/>
        <result column="PO_SUM_PRICE"   property="sumPrice"/>
        <result column="PO_PAY_TYPE"    property="payType"/>
        <result column="PO_STATE"       property="state"/>
        <result column="PO_ORDERDATE"   property="orderDate"/>
        <!-- 배송 상태 표시용 문자열: '입력완료' | '주문취소' | NULL -->
        <result column="SHIP_STATUS"    property="shipStatus"/>
    </resultMap>

    <!-- 목록: 최신 주문일 우선 (ROWNUM 페이징) -->
    <select id="selectOrderStatusList"
            parameterType="kr.co.team3.admin_dto.PageRequestDTO"
            resultMap="OrderStatusMap">
        SELECT * FROM (
        SELECT inner_.*, ROWNUM AS rn
        FROM (
        SELECT
        po.PO_NO,
        po.PO_U_ID,
        uu.U_NAME,
        po.PO_ITEM_COUNT,
        po.PO_SUM_PRICE,
        po.PO_PAY_TYPE,
        po.PO_STATE,
        CAST(po.PO_ORDERDATE AS TIMESTAMP) AS PO_ORDERDATE,

        /* 배송 상태 표시용: 하나라도 배송중/완료/(상품)준비중 있으면 '입력완료', 취소 있으면 '주문취소' */
        CASE
        WHEN EXISTS (
        SELECT 1 FROM ORDER_ITEMS oi
        WHERE oi.OI_PO_NO = po.PO_NO
        AND (oi.OI_DEL_STATUS IN ('배송중','배송완료','상품준비중'))
        ) THEN '입력완료'
        WHEN EXISTS (
        SELECT 1 FROM ORDER_ITEMS oi
        WHERE oi.OI_PO_NO = po.PO_NO
        AND oi.OI_DEL_STATUS = '주문취소'
        ) THEN '주문취소'
        ELSE NULL
        END AS SHIP_STATUS

        FROM PRODUCT_ORDER po
        JOIN U_USER uu ON uu.U_ID = po.PO_U_ID
        <include refid="searchWhere"/>
        ORDER BY po.PO_ORDERDATE DESC, po.PO_NO DESC
        ) inner_
        WHERE ROWNUM &lt;= #{offset} + #{size}
        )
        WHERE rn &gt; #{offset}
    </select>

    <!-- 총 건수 -->
    <select id="countOrderStatus"
            parameterType="kr.co.team3.admin_dto.PageRequestDTO"
            resultType="int">
        SELECT COUNT(*)
        FROM PRODUCT_ORDER po
        JOIN U_USER uu ON uu.U_ID = po.PO_U_ID
        <include refid="searchWhere"/>
    </select>

</mapper>
