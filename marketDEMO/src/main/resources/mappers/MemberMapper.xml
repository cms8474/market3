<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.team3.product_mapper.MemberMapper">

    <!-- 회원가입 - 모든 필드 포함 -->
    <insert id="insertMember" parameterType="kr.co.team3.product_entity.MemberEntity">
        INSERT INTO U_USER (
            U_ID, U_PW, U_NAME, U_BIRTH, U_GENDER, U_MAIL, U_PHONE, 
            U_POSTAL, U_BASE_ADDR, U_DETAIL_ADDR, U_TYPE, U_POINT, U_RANK, U_STATUS
        ) VALUES (
            #{uId}, #{uPw}, #{uName}, #{uBirth}, #{uGender}, #{uMail}, #{uPhone}, 
            #{uPostal}, #{uBaseAddr}, #{uDetailAddr}, #{uType}, #{uPoint}, #{uRank}, #{uStatus}
        )
    </insert>

    <!-- 아이디 중복 확인 -->
    <select id="countById" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM U_USER WHERE U_ID = #{uId}
    </select>

    <!-- 이메일 중복 확인 -->
    <select id="countByMail" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM U_USER WHERE U_MAIL = #{uMail}
    </select>

    <!-- 로그인 -->
    <select id="findByuIdAnduPw" parameterType="map" resultType="kr.co.team3.product_entity.MemberEntity">
        SELECT * FROM U_USER WHERE U_ID = #{uId} AND U_PW = #{uPw}
    </select>

    <!-- 이메일로 회원 찾기 -->
    <select id="findByuMail" parameterType="String" resultType="kr.co.team3.product_entity.MemberEntity">
        SELECT * FROM U_USER WHERE U_MAIL = #{uMail}
    </select>

    <!-- 아이디로 회원 찾기 -->
    <select id="findByuId" parameterType="String" resultType="kr.co.team3.product_entity.MemberEntity">
        SELECT * FROM U_USER WHERE U_ID = #{uId}
    </select>

    <!-- 판매자 정보 등록 -->
    <insert id="insertSellerInfo" parameterType="kr.co.team3.product_entity.SellerInfoEntity">
        INSERT INTO SELLER_INFO (
            S_U_ID, S_COMPANY_NAME, S_SELLER_NO, S_SALES_REG_NUM, 
            S_TEL, S_FAX, S_STATE, S_SELLER_TYPE
        ) VALUES (
            #{sUId}, #{sCompanyName}, #{sSellerNo}, #{sSalesRegNum}, 
            #{sTel}, #{sFax}, #{sState}, #{sSellerType}
        )
    </insert>

    <!-- 약관 내용 조회 -->
    <select id="getTermsContent" parameterType="String" resultType="String">
        SELECT T_BODY FROM M_TERMS WHERE T_NAME = #{termName}
    </select>

    <!--=========================================-->
    <!--관리자 회원목록 조회-->
    <!-- DTO 매핑 -->
    <resultMap id="MemberListMap" type="kr.co.team3.product_dto.MemberDTO">
        <result property="u_id"          column="U_ID"/>
        <result property="u_name"        column="U_NAME"/>
        <result property="u_gender"      column="U_GENDER"/>
        <result property="u_rank"        column="U_RANK"/>
        <result property="u_point"       column="U_POINT"      javaType="java.lang.Integer" jdbcType="INTEGER"/>
        <result property="u_mail"        column="U_MAIL"/>
        <result property="u_phone"       column="U_PHONE"/>
        <!-- 날짜/시간 매핑 명시 (Oracle) -->
        <result property="u_create_day"  column="U_CREATE_DAY" javaType="java.time.LocalDateTime" jdbcType="TIMESTAMP"/>
        <result property="u_status"      column="U_STATUS"/>
    </resultMap>

    <!--아이디 이름 메일 휴대폰 검색-->
    <sql id="searchWhere">
        <where>
            <if test="pageRequestDTO.searchType != null
        and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'u_id'">
                        AND U_ID LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'u_name'">
                        AND U_NAME LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'u_mail'">
                        AND U_MAIL LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'u_phone'">
                        AND U_PHONE LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="selectMemberList"
            parameterType="kr.co.team3.admin_dto.PageRequestDTO"
            resultMap="MemberListMap">
        SELECT
        U_ID, U_NAME, U_GENDER, U_RANK, U_POINT,
        U_MAIL, U_PHONE, U_CREATE_DAY, U_STATUS
        FROM U_USER
        <include refid="searchWhere"/>
        ORDER BY U_CREATE_DAY DESC, U_ID DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotal"
            parameterType="kr.co.team3.admin_dto.PageRequestDTO"
            resultType="int">
        SELECT COUNT(*)
        FROM U_USER
        <include refid="searchWhere"/>
    </select>

</mapper>

