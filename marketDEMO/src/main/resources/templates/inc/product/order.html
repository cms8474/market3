<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ::ì£¼ë¬¸í•˜ê¸°</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/product.css">
    <style>
        .order-page { flex: 1; }
        table.order-table {
            width: 100%; border-collapse: collapse; margin-bottom: 20px;
            font-size: 14px; border-top: 2px solid #222;
        }
        table.order-table th, table.order-table td {
            border-bottom: 1px solid #eee; padding: 10px; text-align: center;
        }
        table.order-table th { 
            background: #fafafa; font-weight: 600; 
        }
        table.order-table .cart-info { 
            display: flex; align-items: center; gap: 10px; text-align: left; 
        }
        table.order-table .cart-info img {
            width: 60px; height: 60px; object-fit: cover; border: 1px solid #ddd; border-radius: 6px;
        }
        table.order-table .cart-info strong { 
            display: block; font-size: 14px; margin-bottom: 4px; 
        }
        table.order-table .total { 
            font-weight: 700; color: #e11d48; 
        }
        .order-section { margin-bottom: 24px; }
        .order-section h3 {
            font-size: 24px; margin-bottom: 10px; border-bottom: 2px solid #333; padding-bottom: 4px;
        }
        .order-section input[type="text"] {
            width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; box-sizing: border-box;
        }
        .order-section textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; resize: none;
        }
        .discount-box, .payment-box {
            border: 1px solid #ddd; padding: 12px; background: #fafafa;
        }
        .payment-options {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .payment-options label { display: flex; align-items: center; gap: 6px; }
        .final-box {
            border: 2px solid #333; padding: 16px; margin-top: 30px; background: #fff;
        }
        .final-box h3 { margin-bottom: 12px; }
        .final-box .row {
            display: flex; justify-content: space-between; margin-bottom: 6px;
        }
        .final-box .total {
            font-weight: bold; font-size: 18px; color: #d32f2f;
        }
        .btn-pay {
            width: 100%; padding: 12px; background: #b71c1c; color: #fff; font-weight: bold; border: none; cursor: pointer; margin-top: 10px;
        }
        .order-section .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .order-section .form-row label {
            width: 100px;
            font-size: 14px;
            font-weight: bold;
        }
        .order-section .form-row input,
        .order-section .form-row textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 4px;
        }
        .order-section .form-row textarea {
            resize: none;
        }
        .order-section .zipcode-box {
            display: flex;
            gap: 8px;
            flex: 1;
        }
        .order-section .zipcode-box input {
            flex: 1;
        }
        .order-section .zipcode-box button {
            padding: 10px 16px;
            border: none;
            background: #b71c1c;
            color: #fff;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }

        .order-section .form-row input,
        .order-section .form-row textarea {
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 4px;
        }

        /* ğŸ“Œ ìˆ˜ë ¹ì¸, íœ´ëŒ€í°, ìš°í¸ë²ˆí˜¸ í¬ê¸° ì¤„ì´ê¸° */
        .order-section .form-row input[type="text"] {
            max-width: 300px;   /* ì¼ë°˜ ì‚¬ì´íŠ¸ì—ì„œ ë§ì´ ì“°ëŠ” í¬ê¸° */
        }

        /* ğŸ“Œ ê¸°ë³¸ì£¼ì†Œ/ìƒì„¸ì£¼ì†ŒëŠ” ê·¸ëŒ€ë¡œ 100% ê¸¸ì´ */
        .order-section .form-row:nth-child(4) input,
        .order-section .form-row:nth-child(5) input {
            max-width: none;
            width: 100%;
        }

        /* ğŸ“Œ ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ */
        .order-section .zipcode-box {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 400px;   /* ìš°í¸ë²ˆí˜¸ ë°•ìŠ¤ ì „ì²´ í¬ê¸° ì œí•œ */
        }
        .order-section .zipcode-box input {
            flex: none;
            width: 200px;       /* ìš°í¸ë²ˆí˜¸ ì…ë ¥ì¹¸ */
        }
        .order-section .zipcode-box button {
            padding: 10px 16px;
            border: none;
            background: #b71c1c;
            color: #fff;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜ */
        .order-section .zipcode-box {
            display: flex;          /* ê°€ë¡œ ë°°ì¹˜ */
            align-items: center;    /* ë†’ì´ ë§ì¶¤ */
            gap: 8px;               /* ê°„ê²© */
            max-width: 400px;
        }

        .order-section .zipcode-box input {
            flex: none;
            width: 200px;           /* ìš°í¸ë²ˆí˜¸ ì…ë ¥ì¹¸ */
        }

        .order-section .zipcode-box button {
            padding: 10px 16px;
            border: none;
            background: #b71c1c;
            color: #fff;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            height: 40px;           /* input ë†’ì´ì— ë§ì¶¤ */
        }

        /* ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜ */
        .order-section .zipcode-box {
            display: flex;          /* ê°€ë¡œ ë°°ì¹˜ */
            align-items: center;    /* ë†’ì´ ë§ì¶¤ */
            gap: 8px;               /* ê°„ê²© */
            max-width: 400px;
        }

        .order-section .zipcode-box input {
            flex: none;
            width: 200px;           /* ìš°í¸ë²ˆí˜¸ ì…ë ¥ì¹¸ */
        }

        .order-section .zipcode-box button {
            padding: 10px 16px;
            border: none;
            background: #b71c1c;
            color: #fff;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            height: 40px;           /* input ë†’ì´ì— ë§ì¶¤ */
        }

        /* ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ ê°€ë¡œ ë°°ì¹˜ */
        .order-section .zipcode-box {
            display: flex;              /* ê°€ë¡œ ì •ë ¬ */
            align-items: center;        /* ì„¸ë¡œ ì¤‘ì•™ ë§ì¶¤ */
            gap: 8px;                   /* ê°„ê²© */
        }

        .order-section .zipcode-box input {
            width: 180px;               /* ìš°í¸ë²ˆí˜¸ ì¹¸ ë„“ì´ */
            height: 36px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

         .order-section .zipcode-box button {
             height: 36px;
             padding: 0 14px;
             border: none;
             background: #b71c1c;
             color: #fff;
             font-weight: bold;
             border-radius: 4px;
             cursor: pointer;
             white-space: nowrap;        /* ê¸€ìê°€ ì¤„ë°”ê¿ˆ ë˜ì§€ ì•Šê²Œ */
         }

         /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
         .toast {
             position: fixed;
             top: 20px;
             right: 20px;
             background: #ff4444;
             color: white;
             padding: 16px 24px;
             border-radius: 8px;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
             z-index: 10000;
             font-size: 14px;
             font-weight: 500;
             opacity: 0;
             transform: translateX(100%);
             transition: all 0.3s ease;
         }
         
         .toast.show {
             opacity: 1;
             transform: translateX(0);
         }
         
         .toast.hide {
             opacity: 0;
             transform: translateX(100%);
         }


    </style>
    
    <script>
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê¸°ë³¸ ê°’ë“¤
        const baseValues = {
            productAmount: /*[[${productAmount}]]*/ 0,
            discountAmount: /*[[${discountAmount}]]*/ 0,
            deliveryFee: /*[[${deliveryFee}]]*/ 0,
            additionalDiscount: /*[[${additionalDiscount}]]*/ 0,
            finalAmount: /*[[${finalAmount}]]*/ 0
        };
        
        let isCouponUsed = false;
        let currentCouponDiscount = 0;
        let isPointUsed = false;
        let currentPointDiscount = 0;
        
         function toggleCoupon() {
             const select = document.getElementById('couponSelect');
             const btn = document.getElementById('couponBtn');
            
            if (!isCouponUsed) {
                // ì¿ í° ì‚¬ìš©í•˜ê¸°
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption.value === '') {
                    showToast('ì¿ í°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                 const deliveryDiscount = selectedOption.dataset.delivery || '';
                 const moneyDiscount = selectedOption.dataset.money || '';
                 
                 // í• ì¸ ê³„ì‚°
                 let discount = 0;
                 
                 // C_DIS_DELIVERY ì²˜ë¦¬
                 if (deliveryDiscount && deliveryDiscount !== 'NULL') {
                     if (deliveryDiscount === 'ë¬´ë£Œ') {
                         // ë°°ì†¡ë¹„ ë¬´ë£Œ: ìµœì¢…ê²°ì œì •ë³´ì˜ ë°°ì†¡ë¹„ ì „ì²´ í• ì¸
                         const deliveryFeeElement = document.querySelector('.final-box .row:nth-child(4) span:last-child');
                         const deliveryFee = deliveryFeeElement.textContent.includes('ë¬´ë£Œ') ? 0 : parseInt(deliveryFeeElement.textContent.replace(/[^0-9]/g, '')) || 0;
                         discount += deliveryFee;
                     } else {
                         // ì •ìˆ˜ê°’: í•´ë‹¹ ê¸ˆì•¡ë§Œí¼ í• ì¸ (ë‹¨, ë°°ì†¡ë¹„ë¥¼ ì´ˆê³¼í•˜ì§€ ì•ŠìŒ)
                         const deliveryValue = parseInt(deliveryDiscount);
                         if (!isNaN(deliveryValue)) {
                             const deliveryFeeElement = document.querySelector('.final-box .row:nth-child(4) span:last-child');
                             const deliveryFee = deliveryFeeElement.textContent.includes('ë¬´ë£Œ') ? 0 : parseInt(deliveryFeeElement.textContent.replace(/[^0-9]/g, '')) || 0;
                             const maxDeliveryDiscount = Math.min(deliveryValue, deliveryFee);
                             discount += maxDeliveryDiscount;
                         }
                     }
                 }
                 
                 // C_DIS_MONEY ì²˜ë¦¬
                 if (moneyDiscount && moneyDiscount !== 'NULL') {
                     if (moneyDiscount.includes('%')) {
                         // í¼ì„¼íŠ¸ í• ì¸: (ìƒí’ˆê°€ê²©-í• ì¸ê°€ê²©) * í¼ì„¼íŠ¸
                         const percentMatch = moneyDiscount.match(/(\d+)%/);
                         if (percentMatch) {
                             const percent = parseInt(percentMatch[1]);
                             
                             // ìƒë‹¨ ì£¼ë¬¸í•˜ê¸° í…Œì´ë¸”ì—ì„œ ì‹¤ì œ ê°’ë“¤ì„ ê³„ì‚°
                             let totalProductPrice = 0; // íŒë§¤ê°€ í•©ê³„
                             let totalDiscountedPrice = 0; // ì´í•© í•©ê³„
                             
                             // í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì—ì„œ ê°’ë“¤ì„ ê°€ì ¸ì˜´
                             const tableRows = document.querySelectorAll('.order-table tbody tr');
                             tableRows.forEach(row => {
                                 const cells = row.querySelectorAll('td');
                                 if (cells.length >= 7) {
                                     const productPrice = parseInt(cells[2].textContent.replace(/[^0-9]/g, '')) || 0;
                                     const totalPrice = parseInt(cells[6].textContent.replace(/[^0-9]/g, '')) || 0;
                                     
                                     totalProductPrice += productPrice;
                                     totalDiscountedPrice += totalPrice;
                                 }
                             });
                             
                             // í¼ì„¼íŠ¸ í• ì¸ì€ í• ì¸ ì „ ìƒí’ˆê°€ê²©(ì´í•© í•©ê³„)ì—ì„œ ê³„ì‚°
                             const percentDiscount = Math.floor(totalDiscountedPrice * percent / 100);
                             discount += percentDiscount;
                         }
                     } else {
                         // ì •ìˆ˜ê°’: í•´ë‹¹ ê¸ˆì•¡ë§Œí¼ í• ì¸
                         const moneyValue = parseInt(moneyDiscount);
                         if (!isNaN(moneyValue)) {
                             discount += moneyValue;
                         }
                     }
                 }
                
                currentCouponDiscount = discount;
                
                // UI ë³€ê²½
                select.disabled = true;
                btn.textContent = 'ì·¨ì†Œ';
                isCouponUsed = true;
                
                // ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                updateAmounts();
                
            } else {
                // ì¿ í° ì·¨ì†Œí•˜ê¸°
                select.disabled = false;
                btn.textContent = 'ì‚¬ìš©í•˜ê¸°';
                isCouponUsed = false;
                currentCouponDiscount = 0;
                
                // ê¸ˆì•¡ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
                updateAmounts();
            }
        }
        
         function updateAmounts() {
             const additionalDiscountDisplay = document.getElementById('additionalDiscountDisplay');
             const finalAmountDisplay = document.getElementById('finalAmountDisplay');
             
             // ì¶”ê°€í• ì¸ í‘œì‹œ (ì¿ í° í• ì¸ + í¬ì¸íŠ¸ í• ì¸)
             const totalAdditionalDiscount = currentCouponDiscount + currentPointDiscount;
             if (totalAdditionalDiscount > 0) {
                 additionalDiscountDisplay.textContent = '-' + totalAdditionalDiscount.toLocaleString() + 'ì›';
             } else {
                 additionalDiscountDisplay.textContent = '0ì›';
             }
             
             // ìƒë‹¨ ì£¼ë¬¸í•˜ê¸° í…Œì´ë¸”ì—ì„œ ì‹¤ì œ ê°’ë“¤ì„ ê³„ì‚°
             let totalProductPrice = 0; // íŒë§¤ê°€ í•©ê³„
             let totalDiscountedPrice = 0; // ì´í•© í•©ê³„
             let totalDeliveryFee = 0; // ë°°ì†¡ë¹„ í•©ê³„
             
             // í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì—ì„œ ê°’ë“¤ì„ ê°€ì ¸ì˜´
             const tableRows = document.querySelectorAll('.order-table tbody tr');
             tableRows.forEach(row => {
                 const cells = row.querySelectorAll('td');
                 if (cells.length >= 7) {
                     const productPrice = parseInt(cells[2].textContent.replace(/[^0-9]/g, '')) || 0;
                     const totalPrice = parseInt(cells[6].textContent.replace(/[^0-9]/g, '')) || 0;
                     const deliveryPrice = cells[5].textContent.includes('ë¬´ë£Œ') ? 0 : parseInt(cells[5].textContent.replace(/[^0-9]/g, '')) || 0;
                     
                     totalProductPrice += productPrice;
                     totalDiscountedPrice += totalPrice;
                     totalDeliveryFee += deliveryPrice;
                 }
             });
             
             const discountedProductAmount = totalDiscountedPrice - totalProductPrice;
             
             // ì „ì²´ì£¼ë¬¸ê¸ˆì•¡ ê³„ì‚°: ì´í•© í•©ê³„ + ë°°ì†¡ë¹„ - ì¶”ê°€í• ì¸ (ì¿ í° + í¬ì¸íŠ¸)
             const newFinalAmount = totalDiscountedPrice + totalDeliveryFee - totalAdditionalDiscount;
             
             finalAmountDisplay.textContent = newFinalAmount.toLocaleString() + 'ì›';
         }
        
        function togglePoint() {
            const pointInput = document.getElementById('pointInput');
            const pointBtn = document.getElementById('pointBtn');
            const currentPoint = parseInt(document.getElementById('currentPoint').textContent);
            
            if (!isPointUsed) {
                // í¬ì¸íŠ¸ ì‚¬ìš©í•˜ê¸°
                const pointValue = parseInt(pointInput.value);
                
                if (!pointValue || pointValue < 5000) {
                    showToast('5,000ì  ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (pointValue > currentPoint) {
                    showToast('ë³´ìœ  í¬ì¸íŠ¸ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                currentPointDiscount = pointValue;
                
                // UI ë³€ê²½
                pointInput.disabled = true;
                pointBtn.textContent = 'ì·¨ì†Œ';
                isPointUsed = true;
                
                // ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                updateAmounts();
                
            } else {
                // í¬ì¸íŠ¸ ì·¨ì†Œí•˜ê¸°
                pointInput.disabled = false;
                pointBtn.textContent = 'ì‚¬ìš©í•˜ê¸°';
                isPointUsed = false;
                currentPointDiscount = 0;
                
                // ê¸ˆì•¡ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
                updateAmounts();
            }
        }
        
        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
        function showToast(message, duration = 3000) {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // ìƒˆ í† ìŠ¤íŠ¸ ìƒì„±
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            // DOMì— ì¶”ê°€
            document.body.appendChild(toast);
            
            // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ show í´ë˜ìŠ¤ ì¶”ê°€
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // ì§€ì •ëœ ì‹œê°„ í›„ ìë™ìœ¼ë¡œ ì œê±°
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                
                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ DOMì—ì„œ ì œê±°
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ í•¨ìˆ˜
        function searchPostcode() {
            const postcodeInput = document.querySelector('input[placeholder="ìš°í¸ë²ˆí˜¸"]');
            const postalValue = postcodeInput.value.trim();
            
            if (!postalValue) {
                showToast('ìš°í¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì‹¤ì œ ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •
            showToast('ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }
        
        // ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
        function processPayment() {
            // ê²°ì œë°©ë²•ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            const selectedPayment = document.querySelector('input[name="pay"]:checked');
            if (!selectedPayment || selectedPayment.value !== 'bank') {
                showToast('ê²°ì œë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë°°ì†¡ì •ë³´ ìˆ˜ì§‘
            const deliveryInfo = {
                recipient: document.querySelector('input[placeholder="ìˆ˜ë ¹ì¸ ì…ë ¥"]').value,
                phone: document.querySelector('input[placeholder="010-0000-0000"]').value,
                postal: document.querySelector('input[placeholder="ìš°í¸ë²ˆí˜¸"]').value,
                baseAddr: document.querySelector('input[placeholder="ê¸°ë³¸ì£¼ì†Œ ì…ë ¥"]').value,
                detailAddr: document.querySelector('input[placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥"]').value,
                request: document.querySelector('textarea[placeholder="ìš”ì²­ì‚¬í•­ ì…ë ¥"]').value
            };
            
            // ê²°ì œ ì •ë³´ ìˆ˜ì§‘
            const paymentInfo = {
                paymentMethod: selectedPayment.value,
                usedCouponId: document.getElementById('couponSelect').value || '',
                usedPoint: parseInt(document.getElementById('pointInput').value) || 0,
                productAmount: parseInt(document.getElementById('productAmountDisplay').textContent.replace(/[^0-9]/g, '')) || 0,
                discountAmount: parseInt(document.getElementById('discountAmountDisplay').textContent.replace(/[^0-9]/g, '')) || 0,
                deliveryFee: parseInt(document.getElementById('deliveryFeeDisplay').textContent.replace(/[^0-9]/g, '')) || 0,
                additionalDiscount: parseInt(document.getElementById('additionalDiscountDisplay').textContent.replace(/[^0-9]/g, '')) || 0,
                finalAmount: parseInt(document.getElementById('finalAmountDisplay').textContent.replace(/[^0-9]/g, '')) || 0,
                earnedPoint: parseInt(document.getElementById('earnedPointDisplay').textContent.replace(/[^0-9]/g, '')) || 0 // í™”ë©´ì— í‘œì‹œëœ ì ë¦½í¬ì¸íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            };
            
            // í¼ ìƒì„±í•˜ì—¬ POSTë¡œ ì „ì†¡
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/product/complete';
            
            // ë°°ì†¡ì •ë³´ í•„ë“œë“¤ ì¶”ê°€
            Object.keys(deliveryInfo).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = deliveryInfo[key];
                form.appendChild(input);
            });
            
            // ê²°ì œì •ë³´ í•„ë“œë“¤ ì¶”ê°€
            Object.keys(paymentInfo).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = paymentInfo[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        }
        
        // ê²°ì œë°©ë²• ì„ íƒ ì´ë²¤íŠ¸
        function handlePaymentMethodChange(event) {
            const selectedValue = event.target.value;
            
            // ë¬´í†µì¥ì…ê¸ˆì´ ì•„ë‹Œ ê²½ìš° í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ ë° ì²´í¬ í•´ì œ
            if (selectedValue !== 'bank') {
                showToast('í˜„ì¬ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²°ì œë°©ì‹ì…ë‹ˆë‹¤.');
                event.target.checked = false;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // í¬ì¸íŠ¸ ì…ë ¥ í•„ë“œì˜ ìµœëŒ€ê°’ ì„¤ì •
            const currentPoint = parseInt(document.getElementById('currentPoint').textContent);
            const pointInput = document.getElementById('pointInput');
            pointInput.max = currentPoint;
            
            // ê²°ì œë°©ë²• ë¼ë””ì˜¤ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const paymentRadios = document.querySelectorAll('input[name="pay"]');
            paymentRadios.forEach(radio => {
                radio.addEventListener('change', handlePaymentMethodChange);
            });
            
            // ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const postcodeButton = document.querySelector('.zipcode-box button');
            if (postcodeButton) {
                postcodeButton.addEventListener('click', searchPostcode);
            }
            
            // ê²°ì œí•˜ê¸° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const paymentButton = document.querySelector('.btn-pay');
            if (paymentButton) {
                paymentButton.addEventListener('click', processPayment);
            }
        });
    </script>
</head>
<body>

<!-- âœ… ê³µí†µ í—¤ë” -->
<th:block th:replace="~{inc/_header :: _header}"/>

<main class="product-page">
    <div class="main-container">

        <!-- âœ… ì‚¬ì´ë“œë°” (ì¹´í…Œê³ ë¦¬ + ë² ìŠ¤íŠ¸ìƒí’ˆ) -->
        <div class="sidebar-container">
            <th:block th:replace="~{inc/_sidebar :: _sidebar}"/>
            <aside class="best-product-list">
                <h3 class="page-title">ë² ìŠ¤íŠ¸ ìƒí’ˆ</h3>
                <ul class="products">
                    <li class="best-product-item">
                        <img th:src="@{/images/logo.png}" alt="ë² ìŠ¤íŠ¸ ìƒí’ˆ">
                        <div class="info">
                            <h4 class="name">ìƒí’ˆëª…</h4>
                            <p class="price">
                                <span class="origin">30,000ì›</span>
                                <span class="discount">10% â†“</span>
                                <span class="sale">27,000ì›</span>
                            </p>
                        </div>
                    </li>
                    <li class="best-product-item">
                        <img th:src="@{/images/logo.png}" alt="ë² ìŠ¤íŠ¸ ìƒí’ˆ">
                        <div class="info">
                            <h4 class="name">ìƒí’ˆëª…</h4>
                            <p class="price">
                                <span class="origin">30,000ì›</span>
                                <span class="discount">10% â†“</span>
                                <span class="sale">27,000ì›</span>
                            </p>
                        </div>
                    </li>
                    <li class="best-product-item">
                        <img th:src="@{/images/logo.png}" alt="ë² ìŠ¤íŠ¸ ìƒí’ˆ">
                        <div class="info">
                            <h4 class="name">ìƒí’ˆëª…</h4>
                            <p class="price">
                                <span class="origin">30,000ì›</span>
                                <span class="discount">10% â†“</span>
                                <span class="sale">27,000ì›</span>
                            </p>
                        </div>
                    </li>
                </ul>
            </aside>
        </div>

        <!-- âœ… ì£¼ë¬¸ ë³¸ë¬¸ -->
        <section class="order-page">

            <!-- ìƒí’ˆì •ë³´ -->
            <div class="order-section">
                <h3>ì£¼ë¬¸í•˜ê¸°</h3>
                <nav class="breadcrumb">HOME &gt; ìƒí’ˆ &gt; ì£¼ë¬¸í•˜ê¸°</nav>
                <table class="order-table">
                    <thead>
                    <tr>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>íŒë§¤ê°€</th>
                        <th>í• ì¸</th>
                        <th>í¬ì¸íŠ¸</th>
                        <th>ë°°ì†¡ë¹„</th>
                        <th>ì´í•©</th>
                    </tr>
                    </thead>
                    <tbody>
                    <th:block th:each="cartItem : ${cartItems}">
                        <!-- ë©”ì¸ ìƒí’ˆ í–‰ -->
                        <tr>
                            <td class="cart-info">
                                <img th:src="@{/images/logo.png}" alt="ìƒí’ˆ">
                                <div>
                                    <strong th:text="${productMap[cartItem.ciPPid] != null ? productMap[cartItem.ciPPid].pName : cartItem.ciPPid}">ìƒí’ˆëª…</strong>
                                </div>
                            </td>
                            <td th:text="${cartItem.ciAmount}">1</td>
                            <td th:text="${productMap[cartItem.ciPPid] != null ? #numbers.formatInteger(productMap[cartItem.ciPPid].pPrice, 0, 'COMMA') + 'ì›' : '0ì›'}">ìƒí’ˆê¸°ë³¸ê°€ê²©</td>
                            <td th:text="${productMap[cartItem.ciPPid] != null and productMap[cartItem.ciPPid].pDiscount != null and productMap[cartItem.ciPPid].pDiscount > 0 ? productMap[cartItem.ciPPid].pDiscount + '%' : '0%'}">í• ì¸ë¥ </td>
                            <td th:text="${productMap[cartItem.ciPPid] != null ? #numbers.formatInteger(productMap[cartItem.ciPPid].pPoint, 0, 'COMMA') + 'P' : '0P'}">ì ë¦½í¬ì¸íŠ¸</td>
                            <td th:text="${productMap[cartItem.ciPPid] != null and productMap[cartItem.ciPPid].pDeliveryPrice != null and productMap[cartItem.ciPPid].pDeliveryPrice > 0 ? #numbers.formatInteger(productMap[cartItem.ciPPid].pDeliveryPrice, 0, 'COMMA') + 'ì›' : 'ë¬´ë£Œë°°ì†¡'}">ë°°ì†¡ë¹„</td>
                            <td class="total" th:text="${#numbers.formatInteger(cartItem.ciTotPrice, 0, 'COMMA')} + 'ì›'">í• ì¸ê°€ê²©</td>
                        </tr>
                        
                        <!-- ì˜µì…˜ í–‰ë“¤ -->
                        <tr th:if="${cartItem.ciOp01 != null and cartItem.ciOp01 != ''}" style="background-color: #f9f9f9;">
                            <td style="padding-left: 40px; font-size: 13px; color: #666;">
                                <span th:text="${optionMap[cartItem.ciOp01] != null ? optionMap[cartItem.ciOp01].popName + ': ' + optionMap[cartItem.ciOp01].popSelection : 'ì˜µì…˜1: ' + cartItem.ciOp01}">ì˜µì…˜1</span>
                            </td>
                            <td th:text="${cartItem.ciAmount}">1</td>
                            <td th:text="${optionMap[cartItem.ciOp01] != null and optionMap[cartItem.ciOp01].popAddPrice != null ? #numbers.formatInteger(optionMap[cartItem.ciOp01].popAddPrice, 0, 'COMMA') + 'ì›' : '0ì›'}">20,000ì›</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        
                        <tr th:if="${cartItem.ciOp02 != null and cartItem.ciOp02 != ''}" style="background-color: #f9f9f9;">
                            <td style="padding-left: 40px; font-size: 13px; color: #666;">
                                <span th:text="${optionMap[cartItem.ciOp02] != null ? optionMap[cartItem.ciOp02].popName + ': ' + optionMap[cartItem.ciOp02].popSelection : 'ì˜µì…˜2: ' + cartItem.ciOp02}">ì˜µì…˜2</span>
                            </td>
                            <td th:text="${cartItem.ciAmount}">1</td>
                            <td th:text="${optionMap[cartItem.ciOp02] != null and optionMap[cartItem.ciOp02].popAddPrice != null ? #numbers.formatInteger(optionMap[cartItem.ciOp02].popAddPrice, 0, 'COMMA') + 'ì›' : '0ì›'}">20,000ì›</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </th:block>
                    </tbody>
                </table>
            </div>

            <!-- ë°°ì†¡ì •ë³´ -->
            <div class="order-section">
                <h3>ë°°ì†¡ì •ë³´</h3>
                <div class="form-row">
                    <label>ìˆ˜ë ¹ì¸</label>
                    <input type="text" th:value="${member != null ? member.uName : ''}" placeholder="ìˆ˜ë ¹ì¸ ì…ë ¥">
                </div>
                <div class="form-row">
                    <label>íœ´ëŒ€í°</label>
                    <input type="text" th:value="${member != null ? member.uPhone : ''}" placeholder="010-0000-0000">
                </div>
                <div class="form-row">
                    <label>ìš°í¸ë²ˆí˜¸</label>
                    <div class="zipcode-box">
                        <input type="text" th:value="${member != null ? member.uPostal : ''}" placeholder="ìš°í¸ë²ˆí˜¸">
                        <button type="button">ê²€ìƒ‰</button>
                    </div>
                </div>

                <div class="form-row">
                    <label>ê¸°ë³¸ì£¼ì†Œ</label>
                    <input type="text" th:value="${member != null ? member.uBaseAddr : ''}" placeholder="ê¸°ë³¸ì£¼ì†Œ ì…ë ¥">
                </div>
                <div class="form-row">
                    <label>ìƒì„¸ì£¼ì†Œ</label>
                    <input type="text" th:value="${member != null ? member.uDetailAddr : ''}" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
                </div>
                <div class="form-row">
                    <label>ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                    <textarea rows="3" placeholder="ìš”ì²­ì‚¬í•­ ì…ë ¥"></textarea>
                </div>
            </div>

            <!-- í• ì¸ì •ë³´ -->
            <div class="order-section discount-box">
                <h3>í• ì¸ì •ë³´</h3>
                <div style="margin-bottom:8px;">
                    <span>í˜„ì¬í¬ì¸íŠ¸ : <span id="currentPoint" th:text="${member != null ? member.uPoint : 0}">7200</span>ì </span>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <span>í¬ì¸íŠ¸ ì‚¬ìš© :</span>
                    <input type="number" id="pointInput" min="5000" max="7200" step="100" placeholder="5,000ì  ì´ìƒ" style="width:150px; padding:6px; border:1px solid #ccc; border-radius:4px;">
                    <span>ì </span>
                    <button id="pointBtn" onclick="togglePoint()">ì‚¬ìš©í•˜ê¸°</button>
                </div>
                <div style="font-size:12px; color:#777; margin-bottom:10px;">
                    í¬ì¸íŠ¸ 5,000ì  ì´ìƒì´ë©´ í˜„ê¸ˆì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥
                </div>
                <div style="display:flex; gap:8px;">
                     <select id="couponSelect">
                         <option value="">ì¿ í° ì„ íƒ</option>
                         <option th:each="userCoupon : ${userCoupons}" 
                                 th:value="${userCoupon.ucCId}"
                                 th:data-delivery="${couponDetailMap[userCoupon.ucCId] != null ? couponDetailMap[userCoupon.ucCId].cDisDelivery : ''}"
                                 th:data-money="${couponDetailMap[userCoupon.ucCId] != null ? couponDetailMap[userCoupon.ucCId].cDisMoney : ''}"
                                 th:text="${couponDetailMap[userCoupon.ucCId] != null ? couponDetailMap[userCoupon.ucCId].cName : userCoupon.ucCId}">
                             ì¿ í°ëª…
                         </option>
                     </select>
                    <button id="couponBtn" onclick="toggleCoupon()">ì‚¬ìš©í•˜ê¸°</button>
                </div>
            </div>

            <!-- ê²°ì œë°©ë²• -->
            <div class="order-section payment-box">
                <h3>ê²°ì œë°©ë²•</h3>
                <div class="payment-options">
                    <label><input type="radio" name="pay" value="credit"> ì‹ ìš©ì¹´ë“œ</label>
                    <label><input type="radio" name="pay" value="check"> ì²´í¬ì¹´ë“œ</label>
                    <label><input type="radio" name="pay" value="transfer"> ê³„ì¢Œì´ì²´</label>
                    <label><input type="radio" name="pay" value="bank"> ë¬´í†µì¥ì…ê¸ˆ</label>
                    <label><input type="radio" name="pay" value="mobile"> íœ´ëŒ€í°ê²°ì œ</label>
                    <label><input type="radio" name="pay" value="kakao"> ì¹´ì¹´ì˜¤í˜ì´</label>
                </div>
            </div>

            <!-- ìµœì¢…ê²°ì œì •ë³´ -->
            <div class="final-box">
                <h3>ìµœì¢…ê²°ì œì •ë³´</h3>
                <div class="row"><span>ìƒí’ˆìˆ˜</span><span th:text="${productCount}">1</span></div>
                <div class="row"><span>ìƒí’ˆê¸ˆì•¡</span><span id="productAmountDisplay" th:text="${#numbers.formatInteger(productAmount, 0, 'COMMA')} + 'ì›'">ìƒí’ˆê¸ˆì•¡</span></div>
                <div class="row"><span>í• ì¸ê¸ˆì•¡</span><span id="discountAmountDisplay" th:text="'-' + ${#numbers.formatInteger(discountAmount, 0, 'COMMA')} + 'ì›'" th:if="${discountAmount > 0}">-1,350ì›</span><span id="discountAmountDisplay" th:text="'0ì›'" th:if="${discountAmount <= 0}">0ì›</span></div>
                <div class="row"><span>ë°°ì†¡ë¹„</span><span id="deliveryFeeDisplay" th:text="${deliveryFee > 0 ? #numbers.formatInteger(deliveryFee, 0, 'COMMA') + 'ì›' : 'ë¬´ë£Œ'}" th:if="${deliveryFee > 0}">3,000ì›</span><span id="deliveryFeeDisplay" th:text="'ë¬´ë£Œ'" th:if="${deliveryFee <= 0}">ë¬´ë£Œ</span></div>
                <div class="row"><span>ì¶”ê°€í• ì¸</span><span id="additionalDiscountDisplay">0ì›</span></div>
                <div class="row total"><span>ì „ì²´ì£¼ë¬¸ê¸ˆì•¡</span><span id="finalAmountDisplay" th:text="${#numbers.formatInteger(finalAmount, 0, 'COMMA')} + 'ì›'">24,650ì›</span></div>
                <div class="row"><span>ì ë¦½ í¬ì¸íŠ¸</span><span id="earnedPointDisplay" th:text="${totalPoints}">270</span></div>
                <button class="btn-pay">ê²°ì œí•˜ê¸°</button>
            </div>
        </section>
    </div>
</main>

<!-- âœ… ê³µí†µ í‘¸í„° -->
<th:block th:replace="~{inc/_footer :: _footer}"/>

</body>
</html>
