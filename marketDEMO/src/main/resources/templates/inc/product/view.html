<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품상세 전체페이지</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/product.css">

    <style>
        /* ===== 레이아웃 ===== */
        .main-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px 12px 40px;
            display: flex;
            gap: 24px;
        }
        .sidebar-container {
            width: 260px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
            align-self: flex-start;
            height: fit-content;
        }
        .content-area { flex:1; min-width:0; }

        .title-bar { border-bottom:2px solid #222; margin-bottom:16px; padding-bottom:8px; }
        .title-bar .page-title { font-size:20px; font-weight:700; margin:0; }
        .breadcrumb { font-size:13px; color:#666; margin-top:4px; }

        /* ===== view1 (상품상세보기) ===== */
        .product-view .pv-top { display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:20px; }
        .pv-gallery {
            border: 1px solid #e5e7eb;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 3 / 2;   /* 기존 4 / 3 → 조금 더 낮게 */
            max-height: 300px;     /* 세로 크기 제한 */
        }
        .pv-gallery img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }



        .pv-info { display:flex; flex-direction:column; gap:12px; font-family:'Noto Sans KR',sans-serif; }
        .pv-top-line { display:flex; align-items:center; gap:10px; font-size:13px; color:#555; flex-wrap:wrap; }
        .pv-title { font-size:20px; font-weight:700; margin:6px 0 4px; }
        .pv-price { border-top:1px solid #eee; border-bottom:1px solid #eee; padding:10px 0; }
        .pv-price .origin { color:#999; text-decoration:line-through; margin-right:8px; font-size:14px; }
        .pv-price .discount { color:#e11d48; font-weight:700; }
        .pv-price .btn-coupon { margin-left:8px; font-size:12px; border:1px solid #ddd; padding:2px 6px; border-radius:4px; background:#fff; cursor:pointer; }
        .pv-price .sale { font-size:24px; color:#111; font-weight:700; margin-top:4px; }
        .pv-delivery { margin-top:6px; display:flex; gap:8px; align-items:center; font-size:12px; }
        .pv-delivery .badge.free { background:#eef7ff; border:1px solid #cfe6ff; color:#2266aa; padding:2px 6px; border-radius:4px; }
        .pv-option select { padding:8px; border:1px solid #ddd; border-radius:6px; min-width:220px; }
        .qty-control { display:inline-flex; border:1px solid #ddd; border-radius:6px; overflow:hidden; }
        .btn-qty { width:34px; height:34px; border:none; background:#f5f5f5; cursor:pointer; font-size:16px; }
        #qtyInput { width:48px; height:34px; border:none; text-align:center; font-size:14px; }
        .pv-total { display:flex; justify-content:flex-end; font-size:14px; color:#555; margin:10px 0; }
        .pv-total .total-price { font-size:16px; font-weight:700; color:#111; margin-left:6px; }
        .pv-actions { display:flex; margin-top:8px; }
        .pv-actions .btn { flex:1; padding:12px 0; font-weight:600; border-radius:4px; border:1px solid #ddd; cursor:pointer; font-size:14px; }
        .btn.cart { background:#f3f4f6; color:#333; }
        .btn.buy { background:#2563eb; color:#fff; border-color:#2563eb; margin-left:6px; }
        .pv-banner { margin-top:8px; height:64px; border:1px dashed #d1d5db; color:#9ca3af; display:flex; align-items:center; justify-content:center; font-size:14px; background:#fafafa; }

        /* ===== view2 (상품정보 제공고시) ===== */
        .product-notice-wrap { border: 1px solid #ccc; margin-top: 20px; }
        .notice-header { display:flex; align-items:center; padding:10px; background:#f7f7f7; border-bottom:1px solid #ccc; }
        .notice-header .icon-label { display:inline-flex; justify-content:center; align-items:center; background:#ce0000; color:#fff; border-radius:50%; width:20px; height:20px; font-weight:bold; font-size:12px; margin-right:10px; }
        .notice-header .section-title { font-size:16px; font-weight:bold; color:#333; margin:0 20px 0 0; }
        .product-notice-table { width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed; }
        .product-notice-table th, .product-notice-table td { border-bottom:1px solid #eee; padding:10px 15px; vertical-align:middle; }
        .product-notice-table th { width:150px; text-align:left; background:#fcfcfc; color:#444; font-weight:normal; border-right:1px solid #eee; }
        .refund-info-text { padding:15px; font-size:12px; line-height:1.6; color:#666; background:#f7f7f7; border-top:1px solid #ccc; }

        /* ===== view3 (리뷰) ===== */
        .review-list { display:flex; flex-direction:column; gap:20px; }
        .review-item { border-bottom:1px solid #eee; padding-bottom:16px; }
        .review-top { display:flex; justify-content:space-between; margin-bottom:8px; }
        .review-top .stars { color:#ffb400; font-size:14px; }
        .review-top .review-date { font-size:12px; color:#666; }
        .review-body { display:flex; gap:16px; }
        .review-thumb { width:80px; height:80px; object-fit:cover; border:1px solid #ddd; border-radius:6px; }
        .review-title { font-size:15px; font-weight:600; margin:0 0 6px; }
        .review-text { font-size:14px; color:#333; line-height:1.5; margin:0; }
        .pagination { display:flex; justify-content:center; gap:6px; margin-top:20px; }
        .pagination a { padding:6px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; color:#333; text-decoration:none; }
        .pagination a.active { background:#2563eb; color:#fff; border-color:#2563eb; }

        /* 상단 큰 타이틀바 (고정) */
        .top-title-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 2px solid #222; /* 밑줄 한 줄 */
        }

        .page-title-main {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .breadcrumb {
            font-size: 13px;
            color: #666;
            white-space: nowrap; /* 줄바꿈 방지 */
        }

        /* 공통 섹션 타이틀 */
        .title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between; /* 제목 왼쪽, 필요시 breadcrumb 오른쪽 */
            margin: 30px 0 16px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd; /* 얇은 한 줄 */
        }

        .title-bar .page-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .pv-detail-img {
            border: 1px solid #eee;
            background: #fff;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .pv-detail-img img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }

        /* 리뷰 섹션 스타일 개선 */
        .review-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .review-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            background: #fff;
        }
        
        .review-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stars {
            color: #fbbf24;
            font-size: 16px;
        }
        
        .pv-stars {
            color: #fbbf24;
            font-size: 14px;
        }
        
        .review-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .review-body {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .review-images {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .review-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }
        
        .review-no-image {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .no-image-text {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .review-content {
            flex: 1;
        }
        
        .review-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: #374151;
        }
        
        .review-text {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.5;
            margin: 0;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }
        
        .pagination a, .pagination span {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .pagination a:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination .active {
            background: #3b82f6;
            color: #fff;
            border-color: #3b82f6;
        }
        
        .pagination .disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

<!-- ✅ header -->
<th:block th:replace="~{inc/_header :: _header}"/>

<main class="product-page">
    <div class="main-container">

        <!-- 사이드바 -->
        <div class="sidebar-container">
            <th:block th:replace="~{inc/_sidebar :: _sidebar}"/>
            <aside class="best-product-list">
                <h3 class="page-title">베스트 상품</h3>
                <ul class="products">
                    <li class="best-product-item">
                        <img th:src="@{/images/logo.png}" alt="베스트 상품">
                        <div class="info">
                            <h4 class="name">상품명</h4>
                            <p class="price"><span class="origin">30,000원</span><span class="discount">10%</span><span class="sale">27,000원</span></p>
                        </div>
                    </li>
                </ul>
            </aside>
        </div>

        <!-- 본문 -->
        <div class="content-area">

            <!--  맨 위 큰 타이틀바 -->
            <div class="top-title-bar">
                <h2 class="page-title-main">상품보기</h2>
                <nav class="breadcrumb">HOME &gt; 패션 · 의류 · 뷰티 &gt; 남성의류</nav>
            </div>



            <!-- view1: 상품상세보기 -->
            <section id="detail" class="product-view">
                <div class="title-bar">
                    <h2 class="page-title">상품상세보기</h2>
                </div>
                <div class="pv-top">
                    <div class="pv-gallery">
                        <img th:if="${product.imageBase64 != null}" 
                             th:src="${product.imageBase64}" 
                             th:alt="${product.pName}">
                        <img th:unless="${product.imageBase64 != null}"
                             th:src="@{/images/logo.png}"
                             th:alt="${product.pName}">
                    </div>
                    <div class="pv-info">
                        <div class="pv-top-line">
                            <span class="pv-sku">상품번호 : <strong th:text="${product.pPid}">10010118412</strong></span>
                            <span class="pv-seller-name" th:text="${product.pSellerId}">(주)상호명</span>
                            <span class="pv-stars" th:if="${averageRating > 0}">
                                <span th:each="i : ${#numbers.sequence(1, 5)}">
                                    <span th:if="${i <= fullStars}">⭐</span>
                                    <span th:if="${i == fullStars + 1 and hasHalfStar}">✨</span>
                                </span>
                                <span class="rating-text" style="margin-left: 8px; color: #666; font-size: 14px;">
                                    (<span th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">4.5</span>점), 리뷰 <span th:text="${reviewPage.totalElements}">1</span>개
                                </span>
                            </span>
                            <span class="pv-stars" th:unless="${averageRating > 0}" 
                                  style="color: #9ca3af; font-size: 12px;">아직 등록된 리뷰가 없습니다.</span>
                        </div>
                        <h2 class="pv-title" th:text="${product.pName}">상품명</h2>
                        <div class="pv-price">
                            <div>
                                <span class="origin" th:text="${#numbers.formatInteger(product.pPrice, 0, 'COMMA')} + '원'">30,000원</span>
                                <span class="discount" th:if="${product.pDiscount > 0}" 
                                      th:text="${product.pDiscount} + '%'">10%</span>
                            </div>
                            <div class="sale" th:text="${#numbers.formatInteger(product.pPrice * (100 - product.pDiscount) / 100, 0, 'COMMA')} + '원'">27,000원</div>
                        </div>
                        <div class="pv-delivery"><span class="badge free">무료배송</span></div>
                        <div class="pv-origin">원산지 - 상세설명 참고</div>
                        
                        <!-- 동적 옵션 섹션 -->
                        <div th:each="optionGroup : ${groupedOptions}" class="pv-option-group" style="margin-bottom: 15px;">
                            <div class="pv-option-label" style="margin-bottom: 8px; font-weight: 600; color: #333;">
                                <span th:text="${optionGroup.key}">옵션명</span>
                            </div>
                            <div class="pv-option-select">
                                <select class="pv-select" th:id="${optionGroup.key}" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-width: 220px;">
                                    <option value="">선택하기</option>
                                    <option th:each="option : ${optionGroup.value}" 
                                            th:value="${option.popNo}" 
                                            th:text="${option.popSelection} + (${option.popAddPrice} > 0 ? ' (+' + ${#numbers.formatInteger(option.popAddPrice, 0, 'COMMA')} + '원)' : '')">
                                        옵션값
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="pv-selected">
                            <div class="pv-selected-item">
                                <span class="item-name">구매 수량</span>
                                <div class="qty-control">
                                    <button type="button" class="btn-qty" data-action="minus">-</button>
                                    <input id="qtyInput" type="text" value="1" inputmode="numeric" />
                                    <button type="button" class="btn-qty" data-action="plus">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="pv-total">총 상품금액 <strong class="total-price" id="totalPrice">기본가격</strong></div>
                        <div class="pv-actions">
                            <button type="button" class="btn cart" onclick="addToCart()">장바구니</button>
                            <button type="button" class="btn buy">구매하기</button>
                        </div>
                        <div class="pv-banner">550 × 64 배너 광고</div>
                    </div>
                </div>
            </section>

            <!-- view1.5: 상품정보 -->
            <section id="info" style="margin-top:40px;">
                <div class="title-bar">
                    <h2 class="page-title">상품정보</h2>
                </div>
                <div class="pv-detail-img">
                    <img th:if="${product.imageBase64 != null}" 
                         th:src="${product.imageBase64}" 
                         th:alt="${product.pName} + ' 상세 정보'">
                    <img th:unless="${product.imageBase64 != null}"
                         th:src="@{/images/logo.png}"
                         th:alt="${product.pName} + ' 상세 정보'">
                </div>
                <div th:if="${product.pDesc != null}" style="margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <h3>상품 설명</h3>
                    <p th:text="${product.pDesc}" style="line-height: 1.6; color: #333;"></p>
                </div>
            </section>


            <!-- view2: 상품정보 제공고시 -->
            <section id="notice" style="margin-top:40px;">
                <div class="title-bar"><h2 class="page-title">상품정보 제공고시</h2></div>
                <div class="product-notice-wrap">
                    <div class="notice-header">
                        <span class="icon-label">1</span>
                        <h3 class="section-title">상품정보 제공고시</h3>
                        <span class="notice-text">[전자상거래법에 따른 상품정보 제공 고시]</span>
                    </div>
                    <table class="product-notice-table">
                        <tbody>
                        <tr><th>상품번호</th><td th:text="${product.pPid}">10010118412</td></tr>
                        <tr><th>상품상태</th><td th:text="${productDetail?.pdState ?: '새상품'}">새상품</td></tr>
                        <tr><th>부가세면세여부</th><td th:text="${productDetail?.pdTax ?: '과세상품'}">과세상품</td></tr>
                        <tr><th>영수증발행여부</th><td th:text="${productDetail?.pdReceipt ?: '발행가능 (신용카드전표, 온라인현금영수증 中)'}">발행가능 (신용카드전표, 온라인현금영수증 中)</td></tr>
                        <tr><th>사업자구분</th><td th:text="${productDetail?.pdSSellerType ?: '통신판매업자'}">통신판매업자</td></tr>
                        <tr><th>브랜드</th><td th:text="${productDetail?.pdBrand ?: '블루포스'}">블루포스</td></tr>
                        <tr><th>원산지</th><td th:text="${productDetail?.pdOrigin ?: '국내생산'}">국내생산</td></tr>
                        <tr><th>제조자/수입국</th><td th:text="${productDetail?.pdMaker ?: product.pSellerId}">상세정보 직접입력</td></tr>
                        <tr><th>제조국</th><td th:text="${productDetail?.pdManufCountry ?: '상세정보 직접입력'}">상세정보 직접입력</td></tr>
                        <tr><th>취급시 주의사항</th><td th:text="${productDetail?.pdCare ?: '상세정보 직접입력'}">상세정보 직접입력</td></tr>
                        <tr><th>제조연월</th><td th:text="${productDetail?.pdManufDate ?: '상세정보 직접입력'}">상세정보 직접입력</td></tr>
                        <tr><th>품질보증기준</th><td th:text="${productDetail?.pdWarrantyInfo ?: '상세정보 직접입력'}">상세정보 직접입력</td></tr>
                        <tr><th>A/S 책임자</th><td th:text="${productDetail?.pdAs ?: product.pSellerId}">상세정보 직접입력</td></tr>
                        <tr><th>전화번호</th><td th:text="${productDetail?.pdPhone ?: '상세정보 직접입력'}">상세정보 직접입력</td></tr>
                        <tr th:if="${product.pRegdate != null}"><th>등록일</th><td th:text="${#temporals.format(product.pRegdate, 'yyyy-MM-dd')}">등록일</td></tr>
                        <tr th:if="${product.pStockQuantity != null}"><th>재고</th><td th:text="${product.pStockQuantity} + '개'">재고</td></tr>
                        <tr th:if="${product.pDeliveryPrice != null}"><th>배송비</th><td th:text="${#numbers.formatInteger(product.pDeliveryPrice, 0, 'COMMA')} + '원'">배송비</td></tr>
                        <tr th:if="${product.pPoint != null}"><th>적립포인트</th><td th:text="${product.pPoint} + 'P'">적립포인트</td></tr>
                        </tbody>
                    </table>
                    <p class="refund-info-text">
                        소비자가 청약철회를 하였음에도 환급이 3영업일 넘게 지연되면 지연이자를 받을 수 있습니다.<br>
                        교환/환불은 <a href="#">[나의쇼핑정보]</a> 에서 신청 가능하며, 판매자에게 문의 바랍니다.
                    </p>
                </div>
            </section>

            <!-- view3: 리뷰 -->
            <section id="review" style="margin-top:40px;">
                <div class="title-bar"><h2 class="page-title">상품리뷰</h2></div>
                <ul class="review-list" th:if="${!reviews.empty}">
                    <li class="review-item" th:each="review : ${reviews}">
                        <div class="review-top">
                            <span class="stars">
                                <span th:each="i : ${#numbers.sequence(1, review.prStar.intValue())}">
                                    <span>⭐</span>
                                </span>
                            </span>
                            <span class="review-date" th:text="${#temporals.format(review.prRegDate, 'yyyy-MM-dd')}">2025-01-01</span>
                        </div>
                        <div class="review-body">
                            <!-- 리뷰 이미지 처리 -->
                            <div class="review-images" th:if="${review.prImages1 != null and review.prImages1 != ''}">
                                <img th:src="${review.prImages1}" class="review-thumb" th:onclick="'showImage(\'' + ${review.prImages1} + '\')'">
                                <img th:if="${review.prImages2 != null and review.prImages2 != ''}" 
                                     th:src="${review.prImages2}" class="review-thumb" th:onclick="'showImage(\'' + ${review.prImages2} + '\')'">
                                <img th:if="${review.prImages3 != null and review.prImages3 != ''}" 
                                     th:src="${review.prImages3}" class="review-thumb" th:onclick="'showImage(\'' + ${review.prImages3} + '\')'">
                            </div>
                            <div class="review-no-image" th:unless="${review.prImages1 != null and review.prImages1 != ''}">
                                <span class="no-image-text">사진없음</span>
                            </div>
                            <div class="review-content">
                                <h4 class="review-title" th:text="${product.pName}">상품명</h4>
                                <p class="review-text" th:text="${review.prBody}">리뷰 내용</p>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="no-reviews" th:if="${reviews.empty}" style="text-align: center; padding: 40px; color: #999;">
                    <p>아직 등록된 리뷰가 없습니다.</p>
                </div>
                <!-- 페이지네이션 -->
                <div class="pagination" th:if="${reviewPage.totalPages > 1}">
                    <!-- 이전 버튼 -->
                    <a th:if="${currentPage > 0}" 
                       th:href="@{/product/view(pPid=${product.pPid}, page=${currentPage - 1})}">이전</a>
                    <span th:unless="${currentPage > 0}" class="disabled">이전</span>
                    
                    <!-- 페이지 번호들 -->
                    <th:block th:each="pageNum : ${#numbers.sequence(0, reviewPage.totalPages - 1)}">
                        <a th:if="${pageNum != currentPage}" 
                           th:href="@{/product/view(pPid=${product.pPid}, page=${pageNum})}"
                           th:text="${pageNum + 1}">1</a>
                        <span th:if="${pageNum == currentPage}" 
                              class="active" 
                              th:text="${pageNum + 1}">1</span>
                    </th:block>
                    
                    <!-- 다음 버튼 -->
                    <a th:if="${currentPage < reviewPage.totalPages - 1}" 
                       th:href="@{/product/view(pPid=${product.pPid}, page=${currentPage + 1})}">다음</a>
                    <span th:unless="${currentPage < reviewPage.totalPages - 1}" class="disabled">다음</span>
                </div>
            </section>

        </div>
    </div>
</main>

<!-- ✅ footer -->
<th:block th:replace="~{inc/_footer :: _footer}"/>

<!-- JS: 수량 변경 및 옵션 가격 계산 -->
<script th:inline="javascript">
    (function(){
        const qtyInput = document.getElementById('qtyInput');
        const totalEl = document.getElementById('totalPrice');
        if(!qtyInput || !totalEl) return;
        
        // 서버에서 받은 상품 정보
        var originalPrice = /*[[${product.pPrice}]]*/ 기본가격;
        var discount = /*[[${product.pDiscount}]]*/ 할인률;
        var deliveryPrice = /*[[${product.pDeliveryPrice}]]*/ 배송비;
        
        // 디버깅용 콘솔 로그
        console.log('상품 정보:', {
            originalPrice: originalPrice,
            discount: discount,
            deliveryPrice: deliveryPrice
        });
        
        // 기본 상품 가격 계산 (할인 적용)
        const basePrice = Math.floor(originalPrice * (100 - discount) / 100);
        console.log('기본 가격 (할인 적용):', basePrice);
        
        // 옵션별 추가 가격 저장
        const optionPrices = new Map();
        
        // 옵션 선택 이벤트 리스너 등록
        document.querySelectorAll('.pv-select').forEach(select => {
            select.addEventListener('change', function() {
                const optionNo = this.value;
                const optionName = this.id;
                
                // 이전 선택된 옵션의 가격 제거
                if (optionPrices.has(optionName)) {
                    optionPrices.delete(optionName);
                }
                
                // 새로 선택된 옵션의 가격 추가
                if (optionNo) {
                    const selectedOption = this.options[this.selectedIndex];
                    const addPriceText = selectedOption.textContent;
                    console.log('선택된 옵션 텍스트:', addPriceText);
                    
                    // "(+30,000원)" 형태의 추가 가격 파싱
                    const addPriceMatch = addPriceText.match(/\(\+([^)]+)\)/);
                    if (addPriceMatch) {
                        const addPrice = parseInt(addPriceMatch[1].replace(/[^\d]/g, '')) || 0;
                        console.log('추출된 추가 가격:', addPrice);
                        optionPrices.set(optionName, addPrice);
                    } else {
                        console.log('추가 가격 없음');
                        optionPrices.set(optionName, 0);
                    }
                }
                
                updateTotalPrice();
            });
        });
        
        function updateTotalPrice() {
            const qty = clamp(qtyInput.value);
            qtyInput.value = qty;
            
            // 옵션 추가 가격 합계
            let totalOptionPrice = 0;
            optionPrices.forEach(price => {
                totalOptionPrice += price;
            });
            
            // 총 가격 계산: (기본가격 + 옵션가격) * 수량 (배송비 제외)
            const totalPrice = (basePrice + totalOptionPrice) * qty;
            
            console.log('가격 계산:', {
                basePrice: basePrice,
                totalOptionPrice: totalOptionPrice,
                qty: qty,
                totalPrice: totalPrice
            });
            
            totalEl.textContent = formatNumber(totalPrice) + '원';
        }
        
        function clamp(n) { 
            n = Number(String(n).replace(/[^0-9]/g,'')) || 1; 
            return Math.max(1, Math.min(999, n)); 
        }
        
        function formatNumber(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // 수량 변경 이벤트
        document.querySelectorAll('.btn-qty').forEach(btn => {
            btn.addEventListener('click', () => {
                qtyInput.value = clamp(qtyInput.value) + (btn.dataset.action === 'plus' ? 1 : -1);
                updateTotalPrice();
            });
        });
        
        qtyInput.addEventListener('input', updateTotalPrice);
        
        // 초기 가격 설정 (페이지 로드 시)
        setTimeout(() => {
            updateTotalPrice();
        }, 100);
    })();
    
    // 장바구니 추가 기능
    function addToCart() {
        const qty = document.getElementById('qtyInput').value;
        const totalPrice = document.getElementById('totalPrice').textContent;
        
        // 총 가격에서 숫자만 추출
        const priceNumber = parseInt(totalPrice.replace(/[^\d]/g, '')) || 0;
        
        // 선택된 옵션들 수집
        const selectedOptions = [];
        document.querySelectorAll('.pv-select').forEach(select => {
            if (select.value) {
                selectedOptions.push(select.value);
            }
        });
        
        // 옵션을 최대 2개까지 전달 (ciOp01, ciOp02)
        const ciOp01 = selectedOptions.length > 0 ? selectedOptions[0] : '';
        const ciOp02 = selectedOptions.length > 1 ? selectedOptions[1] : '';
        
        // 폼 생성하여 POST 요청
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/product/cart/add';
        
        // CSRF 토큰 추가 (널 체크)
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        if (csrfMeta && csrfMeta.content) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfMeta.content;
            form.appendChild(csrfInput);
        }
        
        // 상품 정보 추가
        const fields = [
            { name: 'pPid', value: /*[[${product.pPid}]]*/ '' },
            { name: 'ciOp01', value: ciOp01 },
            { name: 'ciOp02', value: ciOp02 },
            { name: 'ciAmount', value: qty },
            { name: 'ciTotPrice', value: priceNumber }
        ];
        
        fields.forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field.name;
            input.value = field.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
    
    // 이미지 확대 기능
    function showImage(imageSrc) {
        // 모달 창 생성
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
        `;
        
        const img = document.createElement('img');
        img.src = imageSrc;
        img.style.cssText = `
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        `;
        
        modal.appendChild(img);
        document.body.appendChild(modal);
        
        // 클릭 시 모달 닫기
        modal.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    }
</script>

</body>
</html>
