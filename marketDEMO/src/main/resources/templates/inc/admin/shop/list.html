
<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/shop-list.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

        <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
        <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
        <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
        <div class="page">
            <div class="topbar">
                <h4>상점목록</h4>
                <div class="breadcrumb">HOME &gt; 상점관리 &gt; <b>상점목록</b></div>
            </div>

            <!-- 검색 -->
            <form class="search-row" th:action="@{/admin/shop/list}" method="get">
                <select name="searchType" id="searchType">
                    <option value="s_company_name"
                            th:selected="${pageResponseDTO.searchType =='s_company_name'}">상호명</option>
                    <option value="u_name"
                            th:selected="${pageResponseDTO.searchType =='u_name'}">대표</option>
                    <option value="s_seller_no"
                            th:selected="${pageResponseDTO.searchType =='s_seller_no'}">사업자등록번호</option>
                    <option value="s_tel"
                            th:selected="${pageResponseDTO.searchType =='s_tel'}">연락처</option>
                </select>
                <input type="text" name="keyword" placeholder="검색어입력" th:value="${pageResponseDTO.keyword}" />
                <button class="btn" type="submit">검색</button>
            </form>


            <!-- 상태 범례 -->
            <div class="legend">
                <span><i class="dot blue"></i>운영 준비</span>
                <span><i class="dot red"></i>운영 중지</span>
                <span><i class="dot green"></i>운영</span>
            </div>


            <!-- 목록 -->
            <!-- ===== 상점 목록 + 삭제 폼 ===== -->
            <form id="listForm" th:action="@{/admin/shop/delete}" method="post">
                <!-- CSRF 토큰 -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- 목록 테이블 -->
                <table>
                    <thead>
                    <tr>
                        <th class="col-check">
                            <input type="checkbox" id="chkAll" />
                        </th>
                        <th class="col-no">번호</th>
                        <th>상호명</th>
                        <th>대표</th>
                        <th>사업자등록번호</th>
                        <th>통신판매업번호</th>
                        <th>연락처</th>
                        <th>운영</th>
                        <th>관리</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="row, stat : ${pageResponseDTO.dtoList}">
                        <td class="col-check">
                            <input type="checkbox" name="ids" th:value="${row.u_id}" />
                        </td>

                        <td class="col-no" th:text="${pageResponseDTO.startNo - stat.index}">1</td>
                        <td th:text="${row.s_company_name}">(주)다나와</td>
                        <td th:text="${row.u_name}">정우성</td>
                        <td th:text="${row.s_seller_no}">112-12-12345</td>
                        <td th:text="${row.s_sales_reg_num}">2024-서울강남-04433</td>
                        <td th:text="${row.s_tel}">010-1234-1001</td>

                        <td class="status">
                            <i class="dot"
                               th:classappend="${
                                   row.s_state == null ? ' blue' :
                                   (row.s_state == '운영중지' ? ' red' :
                                    (row.s_state == '운영준비' ? ' blue' : ' green'))
                                 }">
                            </i>
                        </td>

                        <td class="actions">
                            <a href="#"
                               class="btnAction"
                               th:attr="data-id=${row.u_id},
                                   data-action=${row.s_state == '운영준비' ? 'approve' :
                                               (row.s_state == '운영중지' ? 'resume' : 'stop')}"
                               th:text="${row.s_state == '운영준비' ? '승인' :
                                                (row.s_state == '운영중지' ? '재개' : '중단')}">
                            </a>
                        </td>


                    </tr>

                    <!-- 비어있을 때 -->
                    <tr th:if="${#lists.isEmpty(pageResponseDTO.dtoList)}">
                        <td colspan="9" class="empty">조회된 상점이 없습니다.</td>
                    </tr>
                    </tbody>
                </table>

                <!-- 테이블 하단 영역 -->
                <div class="table-bottom">
                    <div class="left">
                        <button type="button" class="btn-gray" id="btnDelete">선택삭제</button>
                    </div>

                    <div class="center pagination">
                        <a th:if="${pageResponseDTO.prev}"
                           th:href="@{/admin/shop/list(pg=${pageResponseDTO.start - 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                           class="prev">이전</a>

                        <th:block th:each="num : ${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                            <a th:href="@{/admin/shop/list(pg=${num}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                               th:classappend="${num == pageResponseDTO.pg} ? 'current' : 'num'"
                               th:text="${num}">1</a>
                        </th:block>

                        <a th:if="${pageResponseDTO.next}"
                           th:href="@{/admin/shop/list(pg=${pageResponseDTO.end + 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                           class="next">다음</a>
                    </div>

                    <div class="right">
                        <button type="button" class="btn-blue">상점등록</button>
                    </div>
                </div>
            </form>



            </div>
        </div>

    <!-- 상점 등록 모달 -->
    <div id="Modal" class="modal" aria-hidden="true">
        <div class="modal__backdrop" data-close="true"></div>

        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ModalTitle">
            <div class="modal__header">
                <h5 id="ModalTitle">상점등록</h5>
                <button type="button" class="modal__close" title="닫기" data-close="true">&times;</button>
            </div>

            <form id="Form" class="modal__body"
                  th:action="@{/admin/shop/register}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-grid">

                    <label class="form-label" for="userid">아이디</label>
                    <div class="form-field">
                        <input id="userid" name="u_id" type="text" placeholder="아이디" required />
                        <p class="hint">영문, 숫자 4~12자</p>
                    </div>

                    <label class="form-label" for="pass">비밀번호</label>
                    <div class="form-field">
                        <input id="pass" name="u_pw" type="password" placeholder="비밀번호" required />
                        <p class="hint">영문, 숫자, 특수문자 8~12자</p>
                    </div>

                    <label class="form-label" for="pass2">비밀번호확인</label>
                    <div class="form-field">
                        <input id="pass2" name="pass2" type="password" placeholder="비밀번호 확인" required />
                    </div>

                    <label class="form-label" for="name">상점명</label>
                    <div class="form-field">
                        <input id="name" name="s_company_name" type="text" placeholder="상호명 입력" required />
                        <p class="hint"> 예)  (주)그린마켓 </p>

                    </div>

                    <label class="form-label" for="owner">대표</label>
                    <div class="form-field">
                        <input id="owner" name="u_name" type="text" placeholder="대표자명" required />
                    </div>

                    <label class="form-label" for="bizNo">사업자등록번호</label>
                    <div class="form-field">
                        <input id="bizNo" name="s_seller_no" type="text" inputmode="numeric" placeholder="사업자등록번호 입력" required />
                        <p class="hint"> - 포함 12자리 입력 </p>
                    </div>

                    <label class="form-label" for="mailOrderNo">통신판매업번호</label>
                    <div class="form-field">
                        <input id="mailOrderNo" name="s_sales_reg_num" type="text" placeholder="통신판매업번호 입력" />
                        <p class="hint"> - 포함 12자리 입력 </p>
                    </div>

                    <label class="form-label" for="tel">전화번호</label>
                    <div class="form-field">
                        <input id="tel" name="s_tel" type="text" inputmode="numeric" placeholder="전화번호 입력" />
                    </div>

                    <label class="form-label" for="fax">팩스</label>
                    <div class="form-field">
                        <input id="fax" name="s_fax" type="text" inputmode="numeric" placeholder="팩스번호 입력" />
                    </div>

                    <label class="form-label">주소</label>
                    <div class="form-field">
                        <div class="addr-row">
                            <input id="zip" name="u_postal" type="text" placeholder="우편번호" readonly />
                            <button type="button" class="btn-outline" id="btnFindZip">검색</button>
                        </div>
                        <input id="addr1" name="u_base_addr" type="text" placeholder="기본주소" />
                        <input id="addr2" name="u_detail_addr" type="text" placeholder="상세주소" />
                    </div>

                </div>

                <div class="modal__footer">
                    <button type="button" class="btn-gray" data-close="true">취소</button>
                    <button type="submit" class="btn-green">등록하기</button>
                </div>
            </form>
        </div>
    </div>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:src="@{/js/postcode.js}"></script>
    <script th:src="@{/js/modal.js}"></script>
    <script>
        // ===== 테이블: 전체 선택 =====
        const chkAll = document.getElementById('chkAll');
        chkAll?.addEventListener('change', (e) => {
            document.querySelectorAll('tbody input[type="checkbox"]')
                .forEach(cb => cb.checked = e.target.checked);
        });

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnFindZip')?.addEventListener('click', () => {
                new daum.Postcode({
                    oncomplete: function (data) {
                        var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                        document.getElementById('zip').value = data.zonecode;
                        document.getElementById('addr1').value = addr;
                        document.getElementById('addr2').focus();
                    }
                }).open();
            });
        });

        // 선택삭제 버튼 클릭
        document.getElementById('btnDelete')?.addEventListener('click', (e) => {
            const checked = [...document.querySelectorAll('tbody input[type="checkbox"][name="ids"]:checked')]
                .map(cb => cb.value);

            if (checked.length === 0) {
                alert('선택된 항목이 없습니다.');
                return;
            }
            if (!confirm(`${checked.length}건 삭제할까요?`)) return;

            document.getElementById('listForm').submit();
        });


    </script>
    <script>
        // CSRF
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

        // 상태 버튼 클릭
        document.addEventListener('click', async (e) => {
            const a = e.target.closest('.btnAction');
            if (!a) return;
            e.preventDefault();

            const uId    = a.getAttribute('data-id');
            const action = a.getAttribute('data-action');
            const label  =
                action === 'approve' ? '승인' :
                    action === 'stop'    ? '중단' :
                        action === 'resume'  ? '재개' : '';

            if (!confirm(`${label}하시겠습니까?`)) return;

            try {
                const res = await fetch('/admin/shop/state', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                        [CSRF_HEADER]: CSRF_TOKEN
                    },
                    body: new URLSearchParams({ u_id: uId, action })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    alert(data.message || '상태 변경에 실패했습니다.');
                    return;
                }

                // 성공: 화면 반영
                const newState = data.newState; // '운영', '운영중지'
                // 상태 점 색 갱신
                const row = a.closest('tr');
                const dot = row.querySelector('.status .dot');
                dot.classList.remove('green','red','blue');
                if      (newState === '운영')     dot.classList.add('green');
                else if (newState === '운영중지') dot.classList.add('red');
                else                              dot.classList.add('blue');

                // 액션 버튼 텍스트 / data-action 갱신
                if (newState === '운영') {
                    a.textContent = '중단';
                    a.setAttribute('data-action', 'stop');
                } else if (newState === '운영중지') {
                    a.textContent = '재개';
                    a.setAttribute('data-action', 'resume');
                } else {
                    // 혹시 '운영준비'로 돌아갈 일은 없지만 예비
                    a.textContent = '승인';
                    a.setAttribute('data-action', 'approve');
                }

                alert(`${label}되었습니다.`);

            } catch (err) {
                console.error(err);
                alert('통신 중 오류가 발생했습니다.');
            }
        });
    </script>

</th:block>