<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/shop-list.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

    <style>
        /* 에러 메시지 */
        .error-msg {
            color: #e63946;
            font-size: 13px;
            margin-top: 4px;
            display: none;
        }
        .error-msg.active {
            display: block;
        }
        .form-field input.invalid {
            border-color: #e63946;
            background-color: #fff5f5;
        }

        /* 우편번호 레이어 */
        .postcode-layer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 420px;
            height: 520px;
            background: #fff;
            border: 1px solid #bbb;
            border-radius: 8px;
            box-shadow: 0 24px 60px rgba(0, 0, 0, .35);
            z-index: 10050;
            overflow: hidden;
            display: none;
        }
        .postcode-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #4a4a4a;
            color: #fff;
            padding: 10px 12px;
            font-size: 14px;
        }
        .postcode-close {
            background: transparent;
            border: 0;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            line-height: 1;
        }
        .postcode-body {
            width: 100%;
            height: calc(100% - 42px);
        }
    </style>

    <!-- ■■■ 메인컨텐츠 시작 ■■■ -->
    <div class="page">
        <div class="topbar">
            <h4>상점목록</h4>
            <div class="breadcrumb">HOME &gt; 상점관리 &gt; <b>상점목록</b></div>
        </div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/shop/list}" method="get">
            <select name="searchType" id="searchType">
                <option value="s_company_name" th:selected="${pageResponseDTO.searchType =='s_company_name'}">상호명</option>
                <option value="u_name" th:selected="${pageResponseDTO.searchType =='u_name'}">대표</option>
                <option value="s_seller_no" th:selected="${pageResponseDTO.searchType =='s_seller_no'}">사업자등록번호</option>
                <option value="s_tel" th:selected="${pageResponseDTO.searchType =='s_tel'}">연락처</option>
            </select>
            <input type="text" name="keyword" placeholder="검색어입력" th:value="${pageResponseDTO.keyword}" />
            <button class="btn" type="submit">검색</button>
        </form>

        <!-- 상태 범례 -->
        <div class="legend">
            <span><i class="dot blue"></i>운영 준비</span>
            <span><i class="dot red"></i>운영 중지</span>
            <span><i class="dot green"></i>운영</span>
        </div>

        <!-- 목록 -->
        <form id="listForm" th:action="@{/admin/shop/delete}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <table>
                <thead>
                <tr>
                    <th class="col-check"><input type="checkbox" id="chkAll" /></th>
                    <th class="col-no">번호</th>
                    <th>상호명</th>
                    <th>대표</th>
                    <th>사업자등록번호</th>
                    <th>통신판매업번호</th>
                    <th>연락처</th>
                    <th>운영</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row, stat : ${pageResponseDTO.dtoList}">
                    <td class="col-check"><input type="checkbox" name="ids" th:value="${row.u_id}" /></td>
                    <td class="col-no" th:text="${pageResponseDTO.startNo - stat.index}">1</td>
                    <td th:text="${row.s_company_name}">(주)다나와</td>
                    <td th:text="${row.u_name}">정우성</td>
                    <td th:text="${row.s_seller_no}">112-12-12345</td>
                    <td th:text="${row.s_sales_reg_num}">2024-서울강남-04433</td>
                    <td th:text="${row.s_tel}">010-1234-1001</td>
                    <td class="status">
                        <i class="dot"
                           th:classappend="${
                   row.s_state == null ? ' blue' :
                   (row.s_state == '운영중지' ? ' red' :
                    (row.s_state == '운영준비' ? ' blue' : ' green'))
                 }">
                        </i>
                    </td>
                    <td class="actions">
                        <a href="#"
                           class="btnAction"
                           th:attr="data-id=${row.u_id},
                          data-action=${row.s_state == '운영준비' ? 'approve' :
                                       (row.s_state == '운영중지' ? 'resume' : 'stop')}"
                           th:text="${row.s_state == '운영준비' ? '승인' :
                           (row.s_state == '운영중지' ? '재개' : '중단')}">
                        </a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(pageResponseDTO.dtoList)}">
                    <td colspan="9" class="empty">조회된 상점이 없습니다.</td>
                </tr>
                </tbody>
            </table>

            <div class="table-bottom">
                <div class="left"><button type="button" class="btn-gray" id="btnDelete">선택삭제</button></div>
                <div class="center pagination">
                    <a th:if="${pageResponseDTO.prev}"
                       th:href="@{/admin/shop/list(pg=${pageResponseDTO.start - 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                       class="prev">이전</a>
                    <th:block th:each="num : ${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                        <a th:href="@{/admin/shop/list(pg=${num}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                           th:classappend="${num == pageResponseDTO.pg} ? 'current' : 'num'"
                           th:text="${num}">1</a>
                    </th:block>
                    <a th:if="${pageResponseDTO.next}"
                       th:href="@{/admin/shop/list(pg=${pageResponseDTO.end + 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                       class="next">다음</a>
                </div>
                <div class="right"><button type="button" class="btn-blue">상점등록</button></div>
            </div>
        </form>
    </div>

    <!-- 상점 등록 모달 -->
    <div id="Modal" class="modal" aria-hidden="true">
        <div class="modal__backdrop" data-close="true"></div>
        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ModalTitle">
            <div class="modal__header">
                <h5 id="ModalTitle">상점등록</h5>
                <button type="button" class="modal__close" data-close="true">&times;</button>
            </div>

            <form id="Form" class="modal__body"
                  th:action="@{/admin/shop/register}" method="post" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-grid">
                    <label class="form-label" for="userid">아이디</label>
                    <div class="form-field">
                        <input id="userid" name="u_id" type="text" placeholder="아이디(영문/숫자 4~12)"
                               required pattern="[A-Za-z0-9]{4,12}" />
                        <p class="hint">영문/숫자 4~12자</p>
                        <p class="error-msg"></p>
                    </div>

                    <label class="form-label" for="pass">비밀번호</label>
                    <div class="form-field">
                        <input id="pass" name="u_pw" type="password"
                               placeholder="영문/숫자/특수문자 포함 8~20자"
                               required minlength="8" maxlength="20"
                               pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-\[\]{};':&quot;,.<>/?]).{8,20}$"/>
                        <p class="hint">영문/숫자/특수문자 포함 8~20자</p>
                        <p class="error-msg"></p>
                    </div>

                    <label class="form-label" for="pass2">비밀번호확인</label>
                    <div class="form-field">
                        <input id="pass2" name="pass2" type="password" placeholder="비밀번호 확인" required />
                        <p class="error-msg"></p>
                    </div>

                    <label class="form-label" for="name">상점명</label>
                    <div class="form-field">
                        <input id="name" name="s_company_name" type="text" required placeholder="상호명 입력" />
                    </div>

                    <label class="form-label" for="owner">대표</label>
                    <div class="form-field">
                        <input id="owner" name="u_name" type="text" required placeholder="대표자명" />
                    </div>

                    <label class="form-label" for="bizNo">사업자등록번호</label>
                    <div class="form-field">
                        <input id="bizNo" name="s_seller_no" type="text" inputmode="numeric" placeholder="123-45-67890" required />
                        <p class="error-msg"></p>
                    </div>

                    <!-- 통신판매업번호 -->
                    <label class="form-label" for="mailOrderNo">통신판매업번호</label>
                    <div class="form-field">
                        <input id="mailOrderNo" name="s_sales_reg_num" type="text" placeholder="통신판매업번호 입력" />
                        <p class="hint">예) 2025-서울강남-12345</p>
                    </div>

                    <!-- 팩스번호 -->
                    <label class="form-label" for="fax">팩스</label>
                    <div class="form-field">
                        <input id="fax" name="s_fax" type="text" inputmode="numeric" placeholder="팩스번호 입력" />
                        <p class="hint">예) 02-1234-5678</p>
                    </div>

                    <label class="form-label" for="tel">전화번호</label>
                    <div class="form-field">
                        <input id="tel" name="s_tel" type="text" inputmode="numeric" placeholder="02-1234-5678" />
                        <p class="error-msg"></p>
                    </div>

                    <label class="form-label">주소</label>
                    <div class="form-field">
                        <div class="addr-row">
                            <input id="zip" name="u_postal" type="text" readonly placeholder="우편번호" />
                            <button type="button" class="btn-outline" id="btnFindZip">검색</button>
                        </div>
                        <input id="addr1" name="u_base_addr" type="text" placeholder="기본주소" />
                        <input id="addr2" name="u_detail_addr" type="text" placeholder="상세주소" />
                    </div>
                </div>

                <div class="modal__footer">
                    <button type="button" class="btn-gray" data-close="true">취소</button>
                    <button type="submit" class="btn-green">등록하기</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 우편번호 레이어 -->
    <div id="postcodeLayer" class="postcode-layer">
        <div class="postcode-head">
            <strong>우편번호 검색</strong>
            <button type="button" class="postcode-close" aria-label="닫기">×</button>
        </div>
        <div class="postcode-body"></div>
    </div>

    <!-- 외부 스크립트 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script th:src="@{/js/modal.js}"></script>

    <!-- 유효성검사 + 우편번호 -->
    <script>
        (function(){
            const form = document.getElementById('Form');
            const fields = {
                userid: { re: /^[A-Za-z0-9]{4,12}$/, msg: '아이디는 영문/숫자 4~12자입니다.' },
                pass:   { re: /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-\[\]{};':",.<>/?]).{8,20}$/, msg: '비밀번호는 영문/숫자/특수문자 포함 8~20자입니다.' },
                pass2:  { msg: '비밀번호 확인이 일치하지 않습니다.' },
                bizNo:  { re: /^\d{3}-\d{2}-\d{5}$/, msg: '사업자등록번호 형식을 확인하세요. 예: 123-45-67890' },
                tel:    { re: /^(\d{2,3}-?\d{3,4}-?\d{4})$/, msg: '전화번호 형식을 확인하세요. 예: 02-1234-5678' }
            };
            function showError(input, text){
                const err = input.closest('.form-field')?.querySelector('.error-msg');
                if(!err) return;
                if(text){ input.classList.add('invalid'); err.textContent=text; err.classList.add('active'); }
                else{ input.classList.remove('invalid'); err.textContent=''; err.classList.remove('active'); }
            }
            function validateField(id){
                const el=document.getElementById(id); const val=el.value.trim(); const {re,msg}=fields[id];
                if(id==='pass2'){ const pw=document.getElementById('pass').value;
                    if(val&&val!==pw){showError(el,fields[id].msg);return false;}
                    showError(el,'');return true;}
                if(re&&val&&!re.test(val)){showError(el,msg);return false;}
                showError(el,'');return true;
            }
            Object.keys(fields).forEach(id=>{
                const el=document.getElementById(id);
                el?.addEventListener('input',()=>validateField(id));
                el?.addEventListener('blur',()=>validateField(id));
            });
            form?.addEventListener('submit',e=>{
                let ok=true;
                Object.keys(fields).forEach(id=>{if(!validateField(id)) ok=false;});
                if(!ok) e.preventDefault();
            });
        })();

        // 우편번호 레이어
        (function(){
            const zipBtn=document.getElementById('btnFindZip');
            const layer=document.getElementById('postcodeLayer');
            const body=layer?.querySelector('.postcode-body');
            const closeBtn=layer?.querySelector('.postcode-close');
            const zip=document.getElementById('zip');
            const addr1=document.getElementById('addr1');
            const addr2=document.getElementById('addr2');

            function openPost(){
                if(!layer||!body) return alert('우편번호 레이어 없음');
                layer.style.display='block';
                new daum.Postcode({
                    width:'100%',height:'100%',
                    oncomplete:function(data){
                        const addr=(data.userSelectedType==='R')?data.roadAddress:data.jibunAddress;
                        zip.value=data.zonecode; addr1.value=addr; addr2.focus();
                        closePost();
                    }
                }).embed(body);
            }
            function closePost(){ layer.style.display='none'; }
            zipBtn?.addEventListener('click',e=>{e.preventDefault();openPost();});
            closeBtn?.addEventListener('click',closePost);
            document.addEventListener('keydown',e=>{if(e.key==='Escape'&&layer.style.display==='block')closePost();});
        })();
    </script>
</th:block>
