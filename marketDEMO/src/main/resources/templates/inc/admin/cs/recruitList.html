<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/recruit-list.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

    <!-- CSRF 메타 (fetch용) -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <div class="page">
        <div class="topbar">
            <h4>채용하기 목록</h4>
            <div class="breadcrumb">HOME &gt; 고객센터 &gt; <b>채용하기</b></div>
        </div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/cs/recruit/list}" method="get">
            <select name="searchType" id="searchType">
                <option value="r_no"    th:selected="${searchType}=='r_no'">번호</option>
                <option value="r_dept"  th:selected="${searchType}=='r_dept'">채용부서</option>
                <option value="r_type"  th:selected="${searchType}=='r_type'">채용형태</option>
                <option value="r_title" th:selected="${searchType}=='r_title'">제목</option>
            </select>
            <input type="text" name="keyword" placeholder="검색어입력" th:value="${keyword}">
            <button class="btn" type="submit">검색</button>
        </form>

        <!-- 목록 -->
        <table>
            <thead>
            <tr>
                <th class="col-check"><input type="checkbox" id="chkAll"></th>
                <th>번호</th>
                <th>채용부서</th>
                <th>경력사항</th>
                <th>채용형태</th>
                <th>제목</th>
                <th>작성자</th>
                <th>상태</th>
                <th>모집기간</th>
                <th>작성일</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="recruitment, stat : ${page.content}">
                <td class="col-check">
                    <input type="checkbox" class="rowChk" th:value="${recruitment.recruitNo}">
                </td>

                <!-- 역순 번호 -->
                <td th:text="${page.totalElements - (page.number * page.size) - stat.index}">1</td>

                <td th:text="${recruitment.recruitDept}">-</td>
                <td th:text="${recruitment.recruitCareer}">-</td>
                <td th:text="${recruitment.recruitType}">-</td>
                <td th:text="${recruitment.recruitTitle}">-</td>
                <td>관리자</td>

                <td class="status"
                    th:text="${recruitment.computedStatus}"
                    th:classappend="${recruitment.computedStatus == '모집중'
                     ? ' status--open'
                     : (recruitment.computedStatus == '종료'
                        ? ' status--closed'
                        : ' status--scheduled')}">
                </td>


                <td class="col-date"
                    th:text="${recruitment.recruitStartDate != null && recruitment.recruitEndDate != null ?
                              #temporals.format(recruitment.recruitStartDate, 'yyyy-MM-dd') + ' ~ ' +
                              #temporals.format(recruitment.recruitEndDate, 'yyyy-MM-dd') : '-'}">
                </td>

                <td class="col-date"
                    th:text="${recruitment.recruitRegDate != null ?
                              #temporals.format(recruitment.recruitRegDate, 'yyyy-MM-dd') : '-'}">
                </td>
            </tr>

            <tr th:if="${page.content.size() == 0}">
                <td colspan="10" style="text-align:center;">등록된 채용공고가 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 테이블 하단 영역 -->
        <div class="table-bottom">
            <div class="left">
                <a href="#" class="btn-gray" id="btnDelete">선택삭제</a>
            </div>

            <div class="center pagination">
                <a th:if="${!page.first}"
                   th:href="@{/admin/cs/recruit/list(page=${page.number - 1}, size=${page.size}, searchType=${searchType}, keyword=${keyword})}">
                    이전
                </a>

                <a th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
                   th:href="@{/admin/cs/recruit/list(page=${i}, size=${page.size}, searchType=${searchType}, keyword=${keyword})}"
                   th:text="${i + 1}"
                   th:classappend="${i == page.number} ? 'active'">
                </a>

                <a th:if="${!page.last}"
                   th:href="@{/admin/cs/recruit/list(page=${page.number + 1}, size=${page.size}, searchType=${searchType}, keyword=${keyword})}">
                    다음
                </a>
            </div>

            <div class="right">
                <button class="btn-blue" type="button" data-open="#Modal">채용등록</button>
            </div>
        </div>

        <!-- 채용등록 모달 -->
        <div id="Modal" class="modal" aria-hidden="true">
            <div class="modal__backdrop" data-close="true"></div>

            <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="ModalTitle">
                <div class="modal__header">
                    <h5 id="ModalTitle">채용하기</h5>
                    <button type="button" class="modal__close" title="닫기" data-close="true">&times;</button>
                </div>

                <form id="Form" class="modal__body"
                      th:action="@{/admin/cs/recruit/register}"
                      method="post">

                    <!-- CSRF -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="form-grid">
                        <!-- 제목 -->
                        <label class="form-label" for="recruitTitle">제목</label>
                        <div class="form-field">
                            <input type="text" id="recruitTitle" name="recruitTitle" placeholder="채용 공고 제목 입력" required>
                        </div>

                        <!-- 채용부서 -->
                        <label class="form-label" for="recruitDept">채용부서</label>
                        <div class="form-field">
                            <select id="recruitDept" name="recruitDept" required>
                                <option value="" hidden>채용부서 선택</option>
                                <option value="개발팀">개발팀</option>
                                <option value="디자인팀">디자인팀</option>
                                <option value="마케팅팀">마케팅팀</option>
                                <option value="영업팀">영업팀</option>
                                <option value="경영지원팀">경영지원팀</option>
                            </select>
                        </div>

                        <!-- 경력사항 -->
                        <label class="form-label" for="recruitCareer">경력사항</label>
                        <div class="form-field">
                            <select id="recruitCareer" name="recruitCareer" required>
                                <option value="" hidden>경력사항 선택</option>
                                <option value="신입">신입</option>
                                <option value="경력">경력</option>
                                <option value="무관">무관</option>
                            </select>
                        </div>

                        <!-- 채용형태 -->
                        <label class="form-label" for="recruitType">채용형태</label>
                        <div class="form-field">
                            <select id="recruitType" name="recruitType" required>
                                <option value="" hidden>채용형태 선택</option>
                                <option value="정규직">정규직</option>
                                <option value="계약직">계약직</option>
                                <option value="인턴">인턴</option>
                                <option value="아르바이트">아르바이트</option>
                            </select>
                        </div>

                        <!-- 모집기간 -->
                        <label class="form-label">모집기간</label>
                        <div class="form-field">
                            <div class="range-row">
                                <input type="date" id="recruitStartDate" name="recruitStartDate" required>
                                <span class="tilde">~</span>
                                <input type="date" id="recruitEndDate" name="recruitEndDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="modal__footer">
                        <button type="button" class="btn-gray" data-close="true">취소</button>
                        <button type="submit" class="btn-green">등록하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:src="@{/js/modal.js}"></script>

    <script>
        // 전체 선택
        const chkAll = document.getElementById('chkAll');
        chkAll?.addEventListener('change', (e) => {
            document.querySelectorAll('tbody .rowChk').forEach(cb => cb.checked = e.target.checked);
        });

        // 선택삭제
        document.getElementById('btnDelete')?.addEventListener('click', async (e) => {
            e.preventDefault();
            const ids = Array.from(document.querySelectorAll('tbody .rowChk:checked'))
                .map(cb => parseInt(cb.value, 10));

            if (ids.length === 0) return alert('삭제할 항목을 선택하세요.');
            if (!confirm(`${ids.length}개의 항목을 삭제하시겠습니까?`)) return;

            const token  = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content;

            const res = await fetch('/admin/cs/recruit/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && header ? { [header]: token } : {})
                },
                body: JSON.stringify(ids)
            });

            if (res.ok) {
                alert('삭제되었습니다.');
                location.reload();
            } else {
                alert('삭제 중 오류가 발생했습니다.');
            }
        });
    </script>
</th:block>
