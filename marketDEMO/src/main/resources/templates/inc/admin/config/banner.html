<th:block th:fragment="content">
    <div class="config-banner">
        <a id="pageTop"></a>
        <div class="page-breadcrumb">HOME &gt; 환경설정 &gt; 배너관리</div>
        <h2 class="page-title">배너관리</h2>

        <!-- 탭 -->
        <div class="tabs">
            <a class="tab active" data-tab="MAIN_TOP">메인상단배너</a>
            <a class="tab" data-tab="MAIN_SLIDER">메인슬라이더배너</a>
            <a class="tab" href="#" data-tab="PRODUCT">상품 상세보기 배너</a>
            <a class="tab" href="#" data-tab="LOGIN">회원로그인 배너</a>
            <a class="tab" href="#" data-tab="MY">마이페이지 배너</a>
        </div>

        <!-- 섹션 타이틀 -->
        <section class="card">
            <div class="card-head">
                <h3 id="tabTitle">메인 상단배너</h3>
            </div>

            <div class="card-body">
                <form id="bannerForm" method="post">
                    <div class="table-wrap">
                        <table class="tbl">
                            <colgroup>
                                <col style="width:48px" />
                                <col style="width:68px" />
                                <col style="width:90px" />
                                <col />
                                <col style="width:110px" />
                                <col style="width:150px" />
                                <col style="width:120px" />
                                <col style="width:120px" />
                                <col style="width:90px" />
                                <col style="width:90px" />
                            </colgroup>
                            <thead>
                            <tr>
                                <th><input type="checkbox" id="chkAll"></th>
                                <th>번호</th>
                                <th>이미지</th>
                                <th>배너정보</th>
                                <th>배너위치</th>
                                <th>시작일</th>
                                <th>종료일</th>
                                <th>시작시간</th>
                                <th>종료시간</th>
                                <th>관리</th>
                            </tr>
                            </thead>

                            <tbody>
                            <!-- DB (널방어) 넣고 바꾸기 -->
                            <tr th:each="b, iStat : ${banners}">
                                <td><input type="checkbox" name="ids" th:value="${b.aNo}"></td>
                                <td th:text="${iStat.index + 1}">1</td>
                                <td>
                                    <div class="thumb">
                                        <img th:if="${b.aFile}" th:src="@{'/images/' + ${b.aFile}}" alt="thumb">
                                    </div>
                                </td>
                                <td class="ban-info">
                                    <div class="name" th:text="${b.aName}">배너명</div>
                                    <div class="meta">
                                        크기 : <span th:text="${b.aSize}">1200 × 80</span><br/>
                                        배경색 : <span th:text="${b.aBackColor}">#ffffff</span><br/>
                                        <a th:if="${b.aLink}" th:href="${b.aLink}" target="_blank">배너링크</a>
                                    </div>
                                </td>
                                <td th:text="${b.aLocation}">MAIN_TOP</td>
                                <td th:text="${b.aStartDate!=null ? #temporals.format(b.aStartDate,'yyyy/MM/dd') : ''}">2023/01/01</td>
                                <td th:text="${b.aEndDate!=null ? #temporals.format(b.aEndDate,'yyyy/MM/dd') : ''}">2023/01/07</td>
                                <td th:text="${b.aStartTime!=null ? #temporals.format(b.aStartTime,'HH:mm') : ''}">13:30</td>
                                <td th:text="${b.aEndTime!=null ? #temporals.format(b.aEndTime,'HH:mm') : ''}">15:00</td>
                                <td class="ctrl">
                                </td>
                            </tr>
                            </tbody>
<!--                            <tbody>-->
<!--                            <tr th:each="b, iStat : ${banners}">-->
<!--                                <td><input type="checkbox" name="ids" th:value="${b.id}"></td>-->
<!--                                <td th:text="${iStat.index + 1}">1</td>-->
<!--                                <td>-->
<!--                                    <div class="thumb"><img th:src="${b.thumbUrl}" alt="thumb"></div>-->
<!--                                </td>-->
<!--                                <td class="ban-info">-->
<!--                                    <div class="name" th:text="${b.name}">배너명</div>-->
<!--                                    <div class="meta">-->
<!--                                        크기 : <span th:text="${b.width}">1200</span> × <span th:text="${b.height}">80</span><br/>-->
<!--                                        배경색 : <span th:text="${b.bgColor}">#ffffff</span><br/>-->
<!--                                        <a th:href="${b.linkUrl}" target="_blank">배너링크</a>-->
<!--                                    </div>-->
<!--                                </td>-->
<!--                                <td th:text="${b.position}">MAIN1</td>-->
<!--                                <td th:text="${#temporals.format(b.startDate,'yyyy/MM/dd')}">2023/01/01</td>-->
<!--                                <td th:text="${#temporals.format(b.endDate,'yyyy/MM/dd')}">2023/01/07</td>-->
<!--                                <td th:text="${b.startTime}">13:30</td>-->
<!--                                <td th:text="${b.endTime}">15:00</td>-->
<!--                                <td class="ctrl">-->
<!--                                    <a th:href="@{/admin/config/banner/{id}/enable(id=${b.id})}" class="link">[ 활성 ]</a><br/>-->
<!--                                    <a th:href="@{/admin/config/banner/{id}/disable(id=${b.id})}" class="link">[ 비활성 ]</a><br/>-->
<!--                                    <a th:href="@{/admin/config/banner/{id}/edit(id=${b.id})}" class="link">[ 변경 ]</a>-->
<!--                                </td>-->
<!--                            </tr>-->
<!--                            </tbody>-->
                        </table>
                    </div>

                    <div class="card-foot between">
                        <button type="button" class="btn ghost" id="btnDelete"
                                th:data-url="@{/admin/config/banner/delete}"
                                th:data-csrf-token="${_csrf.token}"
                                th:data-csrf-header="${_csrf.headerName}">
                            선택삭제
                        </button>
                        <a class="btn primary" href="#bannerModal" id="btnNew">배너등록</a>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <script>
        // 탭 라벨만 변경 (데모)
        const tabTitleMap = {
            MAIN_TOP: '메인 상단배너',
            MAIN_SLIDER: '메인 슬라이더배너',
            PRODUCT: '상품 상세보기 배너',
            LOGIN: '회원로그인 배너',
            MY: '마이페이지 배너'
        };
        document.querySelectorAll('.config-banner .tab').forEach(t=>{
            t.addEventListener('click', (e)=>{
                e.preventDefault();
                document.querySelectorAll('.config-banner .tab').forEach(x=>x.classList.remove('active'));
                t.classList.add('active');
                const key = t.dataset.tab;
                document.getElementById('tabTitle').textContent = tabTitleMap[key] || '';
            });
        });

        // 전체선택
        const all = document.getElementById('chkAll');
        if(all){
            all.addEventListener('change', ()=>{
                document.querySelectorAll('input[name="ids"]').forEach(c=> c.checked = all.checked);
            });
        }

        // 삭제
        const DELETE_URL = /*[[@{/admin/config/banner/delete}]]*/ '/admin/config/banner/delete';
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('btnDelete');
            if (!btn) return;

            // CSRF (Spring Security)
            const deleteUrl = btn.dataset.url;
            const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                // 체크된 PK 모으기 (checkbox name="ids", value=배너 PK)
                const ids = Array.from(document.querySelectorAll('input[name="ids"]:checked'))
                    .map(cb => Number(cb.value))
                    .filter(v => !Number.isNaN(v));

                if (ids.length === 0) {
                    alert('삭제할 배너를 선택하세요.');
                    return;
                }

                try {
                    const res = await fetch(DELETE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [header]: token
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(ids)
                    });

                    if (!res.ok) {
                        console.error(await res.text());
                        alert('삭제중 오류가 발생했습니다');
                        return;
                    }
                    const data = await res.json().catch(() => ({}));
                    alert(`삭제 완료 (${data.count ?? ids.length}건)`);
                    location.reload();
                } catch (err) {
                    console.error(err);
                    alert('삭제중 오류가 발생했습니다');
                }
            });
        });
    </script>
    <div id="bannerModal" class="bn-modal" role="dialog" aria-modal="true" aria-labelledby="bnModalTitle">
        <div class="bn-modal__panel">
            <div class="bn-modal__head">
                <strong id="bnModalTitle">배너등록</strong>
                <!-- 닫기: 해시를 #pageTop 으로 돌리면 모달이 숨겨짐 -->
                <a class="bn-modal__close" href="#pageTop" aria-label="닫기">×</a>
            </div>

            <form class="bn-modal__body" th:action="@{/admin/config/banner}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <input type="hidden" name="action" value="create">

                <div class="bn-row">
                    <label class="bn-label" for="bName">배너이름</label>
                    <input id="bName" name="name" type="text" class="bn-input" required placeholder="배너명입력">
                </div>

                <div class="bn-row">
                    <label class="bn-label" for="bSize">배너크기</label>
                    <input id="bSize" name="size" type="text" class="bn-input" placeholder="예) 배너크기 입력">
                </div>

                <div class="bn-row">
                    <label class="bn-label" for="bBg">배경색</label>
                    <input id="bBg" name="bgColor" type="text" class="bn-input" placeholder="배너 배경색 입력">
                </div>

                <div class="bn-row">
                    <label class="bn-label" for="bLink">배너링크</label>
                    <input id="bLink" name="linkUrl" type="url" class="bn-input" placeholder="배너링크입력">
                </div>

                <div class="bn-row">
                    <label class="bn-label" for="bPos">배너위치</label>
                    <select id="bPos" name="position" class="bn-input" required>
                        <option value="">선택</option>
                        <option value="MAIN_TOP"    th:selected="${tab=='MAIN_TOP'}">메인상단</option>
                        <option value="MAIN_SLIDER" th:selected="${tab=='MAIN_SLIDER'}">메인슬라이더</option>
                        <option value="PRODUCT"     th:selected="${tab=='PRODUCT'}">상품상세</option>
                        <option value="LOGIN"       th:selected="${tab=='LOGIN'}">로그인</option>
                        <option value="MY"          th:selected="${tab=='MY'}">마이페이지</option>
                    </select>
                </div>

                <div class="bn-row">
                    <label class="bn-label">노출날짜</label>
                    <div class="bn-inline">
                        <input name="startDate" type="date" class="bn-input">
                        <span class="bn-tilde">~</span>
                        <input name="endDate" type="date" class="bn-input">
                    </div>
                </div>

                <div class="bn-row">
                    <label class="bn-label">노출시간</label>
                    <div class="bn-inline">
                        <input name="startTime" type="time" class="bn-input">
                        <span class="bn-tilde">~</span>
                        <input name="endTime" type="time" class="bn-input">
                    </div>
                </div>

                <div class="bn-row">
                    <label class="bn-label" for="bFile">배너파일</label>
                    <div class="bn-inline">
                        <input id="bFile" name="image" type="file" class="bn-input" accept="image/*" required>
                        <span class="bn-hint">노출 위치에 맞는 크기 권장</span>
                    </div>
                </div>

                <div class="bn-modal__foot">
                    <button type="submit" class="btn primary">등록하기</button>
                </div>
            </form>
        </div>
    </div>
</th:block>