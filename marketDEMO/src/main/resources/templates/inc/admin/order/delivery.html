<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/order-delivery.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

    <!-- ■■■ 메인컨텐츠 시작 ■■■ -->
    <div class="page">
        <div class="topbar">
            <h4>배송현황</h4>
            <div class="breadcrumb">HOME &gt; 주문관리 &gt; <b>배송현황</b></div>
        </div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/order/delivery}" method="get" id="searchForm">
            <select name="searchType" id="searchType">
                <option value="trackingNum" th:selected="${pageResponseDTO.searchType}=='trackingNum'">송장번호</option>
                <option value="poNo"        th:selected="${pageResponseDTO.searchType}=='poNo'">주문번호</option>
                <option value="recipient"   th:selected="${pageResponseDTO.searchType}=='recipient'">수령인</option>
            </select>
            <input type="text" name="keyword" placeholder="검색어입력" th:value="${pageResponseDTO.keyword}" />
            <!-- 페이지/사이즈 유지 -->
            <input type="hidden" name="pg"   th:value="${pageResponseDTO.pg != null ? pageResponseDTO.pg : 1}" />
            <input type="hidden" name="size" th:value="${pageResponseDTO.size != null ? pageResponseDTO.size : 10}" />
            <button class="btn" type="submit" id="btnSearch">검색</button>
        </form>

        <!-- 목록 -->
        <table>
            <thead>
            <tr>
                <th>송장번호</th>
                <th>택배사</th>
                <th>주문번호</th>
                <th>수령인</th>
                <th>상품명</th>
                <th>건수</th>
                <th>물품합계</th>
                <th>배송비</th>
                <th>배송상태</th>
                <th>접수일</th>
            </tr>
            </thead>
            <tbody id="list-body">
            <!-- 데이터 있을 때 -->
            <tr th:each="row : ${pageRequestDTO.dtoList}">
                <td class="order-no">
                    <a href="#" th:data-waybill="${row.trackingNum}"
                       th:text="${row.trackingNum != null ? row.trackingNum : '-'}">-</a>
                </td>
                <td th:text="${row.trackingCompany}">-</td>
                <td th:text="${row.poNo}">-</td>
                <td th:text="${row.recipient}">-</td>
                <td th:text="${row.productName}">-</td>
                <td th:text="${row.itemCount}">0</td>
                <td th:text="${#numbers.formatInteger(row.totalPrice, 3, 'COMMA')}">0</td>
                <td th:text="${#numbers.formatInteger(row.deliveryPrice, 3, 'COMMA')}">0</td>
                <td class="status"
                    th:text="${row.delStatus}"
                    th:classappend="${#strings.equals(row.delStatus,'상품준비중')} ? ' status--ready' :
                              (${#strings.equals(row.delStatus,'배송중')} ? ' status--ing' :
                              (${#strings.equals(row.delStatus,'반품요청')} ? ' status--return' :
                              (${#strings.equals(row.delStatus,'배송완료')} ? ' status--done' : '')))">
                    -
                </td>
                <td class="col-date"
                    th:text="${row.orderDate != null ? #temporals.format(row.orderDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
            </tr>

            <!-- 데이터 없을 때 -->
            <tr th:if="${#lists.isEmpty(pageRequestDTO.dtoList)}">
                <td colspan="10" style="text-align:center;">조회된 데이터가 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 페이지네이션 -->
        <div class="pagination-wrap" th:if="${pageRequestDTO.total > 0}">
            <div class="pagination">
                <!-- 이전 -->
                <a th:if="${pageRequestDTO.prev}"
                   th:href="@{/admin/order/delivery(pg=${pageRequestDTO.start-1},
                    size=${pageRequestDTO.size},
                    searchType=${pageResponseDTO.searchType},
                    keyword=${pageResponseDTO.keyword})}">이전</a>
                <span th:if="${!pageRequestDTO.prev}" class="disabled">이전</span>

                <!-- 페이지 번호 -->
                <a th:each="p : ${#numbers.sequence(pageRequestDTO.start, pageRequestDTO.end)}"
                   th:href="@{/admin/order/delivery(pg=${p},
                    size=${pageRequestDTO.size},
                    searchType=${pageResponseDTO.searchType},
                    keyword=${pageResponseDTO.keyword})}"
                   th:attr="aria-current=${p == pageRequestDTO.pg ? 'page' : null}"
                   th:classappend="${p == pageRequestDTO.pg} ? 'active' : ''"
                   th:text="${p}">1</a>

                <!-- 다음 -->
                <a th:if="${pageRequestDTO.next}"
                   th:href="@{/admin/order/delivery(pg=${pageRequestDTO.end+1},
                    size=${pageRequestDTO.size},
                    searchType=${pageResponseDTO.searchType},
                    keyword=${pageResponseDTO.keyword})}">다음</a>
                <span th:if="${!pageRequestDTO.next}" class="disabled">다음</span>
            </div>
        </div>

        <!-- 상세 모달 -->
        <div id="DetailModal" class="modal" aria-hidden="true">
            <div class="modal__backdrop" data-close="true"></div>
            <div class="modal__dialog order-detail" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
                <!-- 헤더 -->
                <div class="modal__header">
                    <h5 id="detailTitle">배송상세</h5>
                    <div class="order-no" aria-label="송장번호"><span id="od-waybill">—</span></div>
                    <button type="button" class="modal__close" data-close="true" aria-label="닫기">×</button>
                </div>

                <div class="modal__body">
                    <!-- 상품정보 -->
                    <section class="od-section">
                        <header class="od-sec-head"><h6>상품정보</h6></header>
                        <div class="od-products">
                            <table class="od-table">
                                <thead>
                                <tr>
                                    <th>이미지</th>
                                    <th>상품번호</th>
                                    <th>상품명</th>
                                    <th>판매자</th>
                                    <th class="num">가격</th>
                                    <th class="num">수량</th>
                                    <th class="num">배송비</th>
                                    <th class="num">결제금액</th>
                                </tr>
                                </thead>
                                <tbody id="od-items">
                                <!-- JS 렌더링 영역 -->
                                </tbody>
                            </table>

                            <!-- 합계 -->
                            <aside class="od-totals">
                                <dl>
                                    <div><dt>총 상품금액</dt><dd id="od-sumProduct">0 원</dd></div>
                                    <div><dt>총 할인금액</dt><dd id="od-sumDiscount">0 원</dd></div>
                                    <div><dt>배송비</dt><dd id="od-sumShipFee">0 원</dd></div>
                                    <div class="total"><dt>총 결제금액</dt><dd id="od-sumPay">0 원</dd></div>
                                </dl>
                            </aside>
                        </div>
                    </section>

                    <!-- 배송정보 -->
                    <section class="od-section">
                        <header class="od-sec-head"><h6>배송정보</h6></header>
                        <div class="od-info-grid">
                            <div class="label">주문번호</div><div id="od-orderNo">—</div>
                            <div class="label">수령인</div><div id="od-recipient">—</div>
                            <div class="label">연락처</div><div id="od-phone">—</div>
                            <div class="label">배송지주소</div><div id="od-addr">—</div>
                            <div class="label">송장번호</div><div id="od-waybill2">—</div>
                            <div class="label">기타</div><div id="od-memo">—</div>
                        </div>
                    </section>
                </div>

                <div class="modal__footer">
                    <button type="button" class="btn-gray" data-close="true" data-autofocus>닫기</button>
                </div>
            </div>
        </div>
    </div>
    <!-- □□□ 메인컨텐츠 종료 □□□ -->

    <script th:src="@{/js/modal.js}"></script>
    <script>
        // 검색 버튼은 form submit
        document.getElementById('btnSearch')?.addEventListener('click', () => {
            document.getElementById('searchForm').submit();
        });

        // 송장번호 클릭 시 상세 모달 오픈(필요 시 AJAX로 상세 조회)
        document.querySelectorAll('td.order-no a').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const waybill = a.dataset.waybill || '-';
                document.getElementById('od-waybill').textContent = waybill;
                document.getElementById('od-waybill2').textContent = waybill;
                document.getElementById('DetailModal')?.classList.add('open');
            });
        });

        // 모달 닫기
        document.querySelectorAll('[data-close="true"]').forEach(el => {
            el.addEventListener('click', () => {
                document.getElementById('DetailModal')?.classList.remove('open');
            });
        });
    </script>
</th:block>
