<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/order-status.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

    <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
    <div class="page">
        <div class="topbar">
            <h4>주문현황</h4>
            <div class="breadcrumb">HOME &gt; 주문관리 &gt; <b>주문현황</b></div>
        </div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/order/list}" method="get">
            <select name="searchType" id="searchType">
                <option value="po_no"  th:selected="${pageRequestDTO.searchType}=='po_no'">주문번호</option>
                <option value="u_id"   th:selected="${pageRequestDTO.searchType}=='u_id'">주문자</option>
                <option value="u_name" th:selected="${pageRequestDTO.searchType}=='u_name'">주문자명</option>
            </select>
            <input type="text" name="keyword" placeholder="검색어입력"
                   th:value="${pageRequestDTO.keyword}" />
            <button class="btn" type="submit">검색</button>
        </form>

        <!-- 목록 -->
        <table class="table">
            <thead>
            <tr>
                <th>주문번호</th>
                <th>주문자</th>
                <th>주문자명</th>
                <th>주문 건수</th>
                <th>주문합계</th>
                <th>결제수단</th>
                <th>주문 상태</th>
                <th>주문일</th>
                <th>배송</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row, stat : ${pageResponseDTO.dtoList}">
                <td class="order-no">
                    <a href="javascript:void(0)" class="link-detail" th:data-order-no="${row.poNo}">
                        [[${row.poNo}]]
                    </a>
                </td>
                <td th:text="${row.poUId}">abc123</td>
                <td th:text="${row.uName}">홍길동</td>
                <td th:text="${row.itemCount}">2</td>
                <td th:text="${#numbers.formatInteger(row.sumPrice, 3, 'COMMA')}">102,900</td>
                <td th:text="${row.payType}">신용카드</td>

                <!-- 상태 배지 -->
                <!-- 상태 배지 -->
                <td>
                  <span th:text="${#strings.trim(row.state)}"
                        th:classappend="${
                          #strings.trim(row.state) == '결제완료' ? 'status status--ok' :
                          (#strings.trim(row.state) == '주문취소' ? 'status status--cancel' : 'status status--wait')
                        }">
                  </span>
                </td>


                <td>
                    <span th:text="${#temporals.format(row.orderDate, 'yyyy-MM-dd')}">0000-00-00</span><br>
                    <span th:text="${#temporals.format(row.orderDate, 'HH:mm:ss')}">00:00:00</span>
                </td>

                <!-- 배송 입력/상태 -->
                <!-- 배송 -->
                <td>
                    <!-- 결제완료 + 아직 배송입력 전 -->
                    <button type="button"
                            class="btn-ship"
                            th:data-order-no="${row.poNo}"
                            th:if="${#strings.trim(row.state) == '결제완료'
       and (row.shipStatus == null or row.shipStatus == '상품준비중')}"

                    >
                        배송입력
                    </button>

                    <!-- 배송입력 완료 -->
                    <span th:if="${row.shipStatus != null}" class="ship-done">입력완료</span>

                    <!-- 주문취소 -->
                    <span th:if="${#strings.trim(row.state)} == '주문취소'" class="ship-cancel">주문취소</span>

                    <!-- 결제대기 등 기타 상태 -->
                    <span th:if="${#strings.trim(row.state)} == '결제대기'" class="ship-wait">-</span>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(pageResponseDTO.dtoList)}">
                <td colspan="10" class="empty">조회된 주문이 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 페이지네이션 -->
        <div class="pagination-wrap" th:if="${pageResponseDTO.total > 0}">
            <div class="pagination">
                <a th:if="${pageResponseDTO.prev}"
                   th:href="@{/admin/order/list(
                       pg=${pageResponseDTO.start - 1},
                       size=${pageRequestDTO.size},
                       searchType=${pageRequestDTO.searchType},
                       keyword=${pageRequestDTO.keyword}
                   )}">이전</a>

                <a th:each="i : ${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}"
                   th:classappend="${i == pageRequestDTO.pg} ? ' is-active'"
                   th:text="${i}"
                   th:href="@{/admin/order/list(
                       pg=${i},
                       size=${pageRequestDTO.size},
                       searchType=${pageRequestDTO.searchType},
                       keyword=${pageRequestDTO.keyword}
                   )}">1</a>

                <a th:if="${pageResponseDTO.next}"
                   th:href="@{/admin/order/list(
                       pg=${pageResponseDTO.end + 1},
                       size=${pageRequestDTO.size},
                       searchType=${pageRequestDTO.searchType},
                       keyword=${pageRequestDTO.keyword}
                   )}">다음</a>
            </div>
        </div>

        <!-- 배송입력 모달 -->
        <div id="Modal" class="modal" aria-hidden="true">
            <div class="modal__backdrop" data-close="true"></div>
            <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="shipModalTitle">
                <div class="modal__header">
                    <h5 id="shipModalTitle">배송입력</h5>
                    <button type="button" class="modal__close" title="닫기" data-close="true">&times;</button>
                </div>

                <form id="shipForm" class="modal__body" th:action="@{/admin/order/ship}" method="post" novalidate>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="form-grid">
                        <!-- 주문번호 -->
                        <label class="form-label" for="ship-poNo">주문번호</label>
                        <div class="form-field">
                            <input id="ship-poNo" name="poNo" type="text" readonly />
                        </div>

                        <!-- 수령인 -->
                        <label class="form-label" for="ship-recipient">수령인</label>
                        <div class="form-field">
                            <input id="ship-recipient" name="recipient" type="text" readonly />
                        </div>

                        <!-- 연락처 -->
                        <label class="form-label" for="ship-rePhone">연락처</label>
                        <div class="form-field">
                            <input id="ship-rePhone" name="rePhone" type="text" readonly />
                        </div>

                        <!-- 기본주소 -->
                        <label class="form-label" for="ship-baseAddr">기본주소</label>
                        <div class="form-field">
                            <input id="ship-baseAddr" name="baseAddr" type="text" readonly />
                        </div>

                        <!-- 상세주소 -->
                        <label class="form-label" for="ship-detailAddr">상세주소</label>
                        <div class="form-field">
                            <input id="ship-detailAddr" name="detailAddr" type="text" readonly />
                        </div>

                        <!-- 택배사 (입력) -->
                        <label class="form-label" for="ship-courier">택배사</label>
                        <div class="form-field">
                            <select id="ship-courier" name="courier" required>
                                <option value="" hidden>택배사선택</option>
                                <option value="CJ대한통운">CJ대한통운</option>
                                <option value="한진택배">한진택배</option>
                                <option value="롯데택배">롯데택배</option>
                                <option value="우체국택배">우체국택배</option>
                                <option value="로젠택배">로젠택배</option>
                                <option value="쿠팡로지스틱스">쿠팡로지스틱스</option>
                            </select>
                        </div>

                        <!-- 운송장번호 (입력) -->
                        <label class="form-label" for="ship-trackingNo">운송장번호</label>
                        <div class="form-field">
                            <input id="ship-trackingNo" name="trackingNum" type="text" inputmode="numeric" placeholder="운송장번호입력" required />
                        </div>

                        <!-- 기타 메모 (입력) -->
                        <label class="form-label" for="ship-memo">기타</label>
                        <div class="form-field">
                            <textarea id="ship-memo" name="etc" placeholder="기사님 전달사항 등"></textarea>
                        </div>
                    </div>

                    <div class="modal__footer">
                        <button type="button" class="btn-gray" data-close="true">취소</button>
                        <button type="submit" class="btn-green">등록하기</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 주문상세 모달 -->
        <div id="DetailModal" class="modal" aria-hidden="true">
            <div class="modal__backdrop" data-close="true"></div>
            <div class="modal__dialog order-detail" role="dialog" aria-modal="true" aria-labelledby="orderDetailTitle">
                <div class="modal__header">
                    <h5 id="orderDetailTitle">주문상세</h5>
                    <button type="button" class="modal__close" data-close="true">&times;</button>
                </div>

                <div class="modal__body">
                    <div class="od-head">
                        주문번호 <span id="od-orderNo" class="od-no">—</span>
                    </div>

                    <!-- 상품정보 -->
                    <section class="od-section">
                        <h6>상품정보</h6>
                        <table class="table order-items">
                            <thead>
                            <tr>
                                <th>상품번호</th>
                                <th>상품명</th>
                                <th>판매자</th>
                                <th>가격</th>
                                <th>할인</th>
                                <th>수량</th>
                                <th>배송비</th>
                                <th>결제금액</th>
                            </tr>
                            </thead>
                            <tbody id="od-products-body">
                            <tr><td colspan="8" class="empty">상품정보를 불러오는 중...</td></tr>
                            </tbody>
                        </table>

                        <div class="order-sum">
                            <ul>
                                <li>총 상품금액 <span id="od-sumProduct">0 원</span></li>
                                <li>총 할인금액 <span id="od-sumDiscount">0 원</span></li>
                                <li>배송비 <span id="od-sumShipFee">0 원</span></li>
                                <li><b>총 결제금액 <span id="od-sumPay">0 원</span></b></li>
                            </ul>
                        </div>
                    </section>

                    <!-- 결제정보 -->
                    <section class="od-section">
                        <h6>결제정보</h6>
                        <table class="table">
                            <tr><th>결제번호</th><td id="od-pay-orderNo">—</td></tr>
                            <tr><th>결제방법</th><td id="od-pay-type">—</td></tr>
                            <tr><th>주문자</th><td id="od-pay-user">—</td></tr>
                            <tr><th>연락처</th><td id="od-pay-tel">—</td></tr>
                            <tr><th>결제상태</th><td id="od-pay-status">—</td></tr>
                            <tr><th>총 결제금액</th><td id="od-pay-total">—</td></tr>
                        </table>
                    </section>

                    <!-- 배송정보 -->
                    <section class="od-section">
                        <h6>배송정보</h6>
                        <table class="table">
                            <tr><th>수취인</th><td id="od-ship-name">—</td></tr>
                            <tr><th>연락처</th><td id="od-ship-tel">—</td></tr>
                            <tr><th>주소</th><td id="od-ship-addr">—</td></tr>
                        </table>
                    </section>
                </div>
            </div>
        </div>
    </div>
    <!-- □□□□□ 메인컨텐츠 종료 □□□□□ -->

    <!-- 공통 JS -->
    <script>
        // 숫자 포맷 (상세 모달 표시용)
        const nf = (n) => Number(n || 0).toLocaleString();
    </script>

    <!-- 주문상세 모달: 로딩/바인딩 -->
    <script>
        const detailModal = document.getElementById('DetailModal');
        const productsBody = document.getElementById('od-products-body');
        let detailLoading = false;

        document.querySelectorAll('.link-detail').forEach(a=>{
            a.addEventListener('click', async ()=>{
                if (detailLoading) return;
                detailLoading = true;
                const poNo = a.dataset.orderNo;
                document.getElementById('od-orderNo').textContent = poNo || '—';
                document.getElementById('od-pay-orderNo').textContent = poNo || '—';
                productsBody.innerHTML = '<tr><td colspan="8" class="empty">상품정보를 불러오는 중...</td></tr>';

                try{
                    const res = await fetch(`/admin/order/detail?poNo=${encodeURIComponent(poNo)}`, {
                        headers: { 'Accept': 'application/json' }
                    });
                    if(!res.ok) throw new Error('상세 조회 실패');
                    const d = await res.json();

                    // 상품정보
                    productsBody.innerHTML = '';
                    if(d.items?.length){
                        d.items.forEach(it=>{
                            productsBody.insertAdjacentHTML('beforeend', `
                                <tr>
                                    <td>${it.productPid ?? '-'}</td>
                                    <td>${it.productName ?? '-'}</td>
                                    <td>${it.sellerName ?? it.sellerId ?? '-'}</td>
                                    <td class="num">${nf(it.price)}</td>
                                    <td class="num">${nf(it.discount)}</td>
                                    <td class="num">${it.quantity ?? 0}</td>
                                    <td class="num">${nf(it.deliveryFee)}</td>
                                    <td class="num"><b>${nf(it.itemTotalPrice)}</b></td>
                                </tr>`);
                        });
                    } else {
                        productsBody.innerHTML = '<tr><td colspan="8" class="empty">상품이 없습니다.</td></tr>';
                    }

                    // 합계
                    document.getElementById('od-sumProduct').textContent = nf(d.sumPrice) + ' 원';
                    document.getElementById('od-sumDiscount').textContent = nf(d.discount) + ' 원';
                    document.getElementById('od-sumShipFee').textContent = nf(d.deliveryPrice) + ' 원';
                    document.getElementById('od-sumPay').textContent = nf(d.totalPrice) + ' 원';

                    // 결제정보
                    document.getElementById('od-pay-type').textContent = d.payType ?? '—';
                    document.getElementById('od-pay-user').textContent = d.userName ?? d.userId ?? '—';
                    document.getElementById('od-pay-tel').textContent = d.userPhone ?? '—';
                    document.getElementById('od-pay-status').textContent = d.state ?? '—';
                    document.getElementById('od-pay-total').textContent = nf(d.totalPrice) + ' 원';

                    // 배송정보
                    document.getElementById('od-ship-name').textContent = d.recipient ?? '—';
                    document.getElementById('od-ship-tel').textContent = d.rePhone ?? '—';
                    const addr = [d.baseAddr, d.detailAddr].filter(Boolean).join(' ');
                    document.getElementById('od-ship-addr').textContent = addr || '—';

                }catch(err){
                    console.error(err);
                    productsBody.innerHTML = '<tr><td colspan="8" class="empty">상세 정보를 불러오지 못했습니다.</td></tr>';
                }finally{
                    detailLoading = false;
                }

                detailModal.classList.add('is-open');
                document.body.classList.add('modal-open');
            });
        });
    </script>

    <!-- 배송입력 모달: 열기/프리필/검증 -->
    <script>
        (() => {
            const shipModal       = document.getElementById('Modal');
            const form            = document.getElementById('shipForm');
            const poNoInput       = document.getElementById('ship-poNo');
            const recipientInput  = document.getElementById('ship-recipient');
            const rePhoneInput    = document.getElementById('ship-rePhone');
            const baseAddrInput   = document.getElementById('ship-baseAddr');
            const detailAddrInput = document.getElementById('ship-detailAddr');
            const courierSelect   = document.getElementById('ship-courier');
            const trackingInput   = document.getElementById('ship-trackingNo');
            const memoInput       = document.getElementById('ship-memo');

            /** 모달 닫기 (공통) */
            const closeModal = (modalEl) => {
                if (!modalEl) return;
                modalEl.classList.remove('is-open');
                const hasAnyOpen = document.querySelector('.modal.is-open');
                if (!hasAnyOpen) document.body.classList.remove('modal-open');
            };

            /** 열기(결제완료 버튼만 존재) + 프리필 */
            document.querySelectorAll('.btn-ship').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const poNo = btn.dataset.orderNo;
                    poNoInput.value = poNo || '';

                    // 입력 필드 초기화
                    courierSelect.value = '';
                    trackingInput.value = '';
                    memoInput.value = '';

                    // 프리필 (주문번호/수령인/연락처/주소)
                    try {
                        const res = await fetch(`/admin/order/ship/prefill?poNo=${encodeURIComponent(poNo)}`, {
                            headers: { 'Accept': 'application/json' }
                        });
                        if (!res.ok) throw new Error('prefill failed');
                        const d = await res.json();
                        recipientInput.value  = d.recipient  ?? '';
                        rePhoneInput.value    = d.rePhone    ?? '';
                        baseAddrInput.value   = d.baseAddr   ?? '';
                        detailAddrInput.value = d.detailAddr ?? '';
                    } catch (e) {
                        console.error(e);
                        recipientInput.value  = '';
                        rePhoneInput.value    = '';
                        baseAddrInput.value   = '';
                        detailAddrInput.value = '';
                    }

                    shipModal?.classList.add('is-open');
                    document.body.classList.add('modal-open');
                });
            });

            /** 제출: AJAX로 /admin/order/ship 호출 후 셀을 '입력완료'로 갱신 */
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!courierSelect.value) {
                    alert('택배사를 선택해 주세요.');
                    courierSelect.focus();
                    return;
                }
                if (!trackingInput.value.trim()) {
                    alert('운송장번호를 입력해 주세요.');
                    trackingInput.focus();
                    return;
                }

                try {
                    const fd = new FormData(form); // name="poNo,courier,trackingNum,etc" 주의
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: fd,
                        headers: { 'Accept': 'application/json' } // 컨트롤러에서 JSON 응답 주면 best
                    });

                    if (!res.ok) throw new Error('ship submit failed');
                    // JSON으로 {ok:true} 같은 응답이면 파싱 가능. 필요없으면 생략해도 됨.
                    // const data = await res.json();

                    // UI 갱신: 해당 행의 배송 셀을 '입력완료'로 변경
                    const poNo = poNoInput.value;
                    const cell = document.querySelector(`.ship-cell[data-order-no="${poNo}"]`);
                    if (cell) cell.innerHTML = '<span class="ship-done">입력완료</span>';

                    closeModal(shipModal);
                } catch (err) {
                    console.error(err);
                    alert('배송정보 등록에 실패했습니다. 잠시 후 다시 시도해 주세요.');
                }
            });

            /** 백드롭/X/ESC로 닫기 (이미 공통 코드 있으면 그대로 써도 됨) */
            shipModal?.addEventListener('click', (e) => {
                const isBackdrop = e.target.classList.contains('modal__backdrop');
                const askClose = e.target.closest('[data-close="true"]');
                if (isBackdrop || askClose) {
                    e.preventDefault();
                    closeModal(shipModal);
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal(shipModal);
            });
        })();
    </script>

    <!-- 모달 닫기: 백드롭 / X / ESC -->
    <script>
        (() => {
            const closeModal = (modalEl) => {
                if (!modalEl) return;
                modalEl.classList.remove('is-open');
                const hasAnyOpen = document.querySelector('.modal.is-open');
                if (!hasAnyOpen) document.body.classList.remove('modal-open');
            };

            document.querySelectorAll('.modal').forEach((modalEl) => {
                modalEl.addEventListener('click', (e) => {
                    const isBackdrop = e.target.classList.contains('modal__backdrop');
                    const askClose = e.target.closest('[data-close="true"]');
                    if (isBackdrop || askClose) {
                        e.preventDefault();
                        closeModal(modalEl);
                    }
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.is-open').forEach(closeModal);
                }
            });
        })();
    </script>
</th:block>
