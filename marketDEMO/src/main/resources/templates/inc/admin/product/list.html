<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/product-list.css"/>

    <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
    <div class="page">
        <div class="topbar">
            <h4>상품현황</h4>
            <div class="breadcrumb">HOME &gt; 상품관리 &gt; <b>상품목록</b></div>
        </div>

        <!-- 메시지 -->
        <div th:if="${msg}"   class="alert alert--ok"    th:text="${msg}"></div>
        <div th:if="${error}" class="alert alert--error" th:text="${error}"></div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/product/list}" method="get">
            <select name="searchType" id="searchType" aria-label="검색 대상">
                <option value=""        th:selected="${pageResponseDTO.searchType == null or pageResponseDTO.searchType == ''}">선택</option>
                <option value="name"    th:selected="${pageResponseDTO.searchType == 'name'}">상품명</option>
                <option value="pid"     th:selected="${pageResponseDTO.searchType == 'pid'}">상품코드</option>
                <option value="seller"  th:selected="${pageResponseDTO.searchType == 'seller'}">판매자 키워드</option>
            </select>
            <input type="text" name="keyword" placeholder="검색어입력" th:value="${pageResponseDTO.keyword}"/>
            <!-- 페이징 유지 -->
            <input type="hidden" name="pg"   th:value="${pageResponseDTO.pg}"/>
            <input type="hidden" name="size" th:value="${pageResponseDTO.size}"/>
            <button class="btn" type="submit">검색</button>
        </form>

        <!-- 선택삭제용 폼 (테이블+하단영역을 함께 감싼다. 단건삭제는 별도 폼) -->
        <form id="bulkForm" th:action="@{/admin/product/delete-bulk}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <!-- 상태 유지 -->
            <input type="hidden" name="pg"         th:value="${pageResponseDTO.pg}"/>
            <input type="hidden" name="size"       th:value="${pageResponseDTO.size}"/>
            <input type="hidden" name="searchType" th:value="${pageResponseDTO.searchType}"/>
            <input type="hidden" name="keyword"    th:value="${pageResponseDTO.keyword}"/>

            <!-- 목록 -->
            <table class="table">
                <thead>
                <tr>
                    <th class="col-check"><input type="checkbox" id="chkAll"/></th>
                    <th class="col-no">사진</th>
                    <th>상품코드</th>
                    <th>상품명</th>
                    <th class="t-right">판매가격</th>
                    <th class="t-right">할인율</th>
                    <th class="t-right">재고</th>
                    <th>판매자</th>
                    <th class="t-right">조회</th>
                    <th>관리</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="p, idx : ${pageResponseDTO.dtoList}">
                    <td class="col-check">
                        <input type="checkbox" name="pids" th:value="${p.pid}"/>
                    </td>

                    <td class="center">
                        <img class="thumb"
                             th:if="${p.imageUrl != null}"
                             th:src="@{${p.imageUrl}}"
                             alt="상품 이미지"
                             style="width:64px;height:64px;object-fit:cover;border-radius:6px;"/>
                        <div th:if="${p.imageUrl == null}" class="thumb thumb--placeholder"
                             style="width:64px;height:64px;border-radius:6px;background:#f2f2f2;display:flex;align-items:center;justify-content:center;color:#888;">
                            No Image
                        </div>
                    </td>

                    <td class="col-code" th:text="${p.pid}">PID</td>
                    <td class="col-name" th:text="${p.name}">상품명</td>
                    <td class="num col-price" th:text="${#numbers.formatInteger(p.salePrice, 3, 'COMMA')}">0</td>
                    <td class="num col-disc"  th:text="${p.discount} + '%'">0%</td>
                    <td class="num col-stock" th:text="${#numbers.formatInteger(p.stockQty, 3, 'COMMA')}">0</td>
                    <td class="col-seller"    th:text="${p.sellerName}">seller</td>
                    <td class="num col-views" th:text="${#numbers.formatInteger(p.viewCount, 3, 'COMMA')}">0</td>
                    <td class="actions col-actions">
                        <a th:href="@{/admin/product/modify(pid=${p.pid})}">수정</a>
                        <!-- 단건 삭제: 숨김 폼으로 POST -->
                        <button type="button" class="link danger delete-one" th:data-pid="${p.pid}">삭제</button>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(pageResponseDTO.dtoList)}">
                    <td colspan="10" class="t-center">등록된 상품이 없습니다.</td>
                </tr>
                </tbody>
            </table>

            <!-- 테이블 하단 영역(같은 폼 내부) -->
            <div class="table-bottom">
                <div class="left">
                    <button type="submit" class="btn-gray"
                            onclick="return confirm('선택한 항목을 삭제하시겠습니까?');">선택삭제</button>
                </div>

                <div class="center pagination">
                    <a th:if="${pageResponseDTO.prev}"
                       th:href="@{/admin/product/list(pg=${pageResponseDTO.start - 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                       class="prev">이전</a>

                    <th:block th:each="num : ${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                        <a th:href="@{/admin/product/list(pg=${num}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                           th:classappend="${num == pageResponseDTO.pg} ? 'current' : 'num'"
                           th:text="${num}">1</a>
                    </th:block>

                    <a th:if="${pageResponseDTO.next}"
                       th:href="@{/admin/product/list(pg=${pageResponseDTO.end + 1}, searchType=${pageResponseDTO.searchType}, keyword=${pageResponseDTO.keyword})}"
                       class="next">다음</a>
                </div>

                <div class="right">
                    <a th:href="@{/admin/product/register}" class="btn-blue">상품등록</a>
                </div>
            </div>
        </form>

        <!-- 단건삭제 숨김 폼 (폼 중첩 방지용, bulkForm 밖에 위치) -->
        <form id="deleteOneForm" th:action="@{/admin/product/delete}" method="post" style="display:none;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="pid" value=""/>
            <!-- 상태 유지 -->
            <input type="hidden" name="pg"         th:value="${pageResponseDTO.pg}"/>
            <input type="hidden" name="size"       th:value="${pageResponseDTO.size}"/>
            <input type="hidden" name="searchType" th:value="${pageResponseDTO.searchType}"/>
            <input type="hidden" name="keyword"    th:value="${pageResponseDTO.keyword}"/>
        </form>
    </div>
    <!-- □□□□□ 메인컨텐츠 종료 □□□□□ -->

    <script>
        // 전체 선택
        document.getElementById('chkAll')?.addEventListener('change', (e) => {
            document.querySelectorAll('tbody input[type="checkbox"][name="pids"]')
                .forEach(cb => cb.checked = e.target.checked);
        });

        // 단건 삭제
        document.querySelectorAll('.delete-one').forEach(btn => {
            btn.addEventListener('click', () => {
                const pid = btn.getAttribute('data-pid');
                if (!pid) return;
                if (!confirm('이 상품을 삭제하시겠습니까?')) return;
                const form = document.getElementById('deleteOneForm');
                form.querySelector('input[name="pid"]').value = pid;
                form.submit();
            });
        });

        // 선택삭제 사전 체크 (선택 항목 없을 때 방지)
        document.getElementById('bulkForm')?.addEventListener('submit', (e) => {
            const checked = document.querySelectorAll('input[name="pids"]:checked');
            if (checked.length === 0) {
                e.preventDefault();
                alert('선택된 항목이 없습니다.');
            }
        });
    </script>
</th:block>
