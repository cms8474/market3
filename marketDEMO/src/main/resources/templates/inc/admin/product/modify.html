<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/product-register.css"/>

    <div class="page">
        <div class="topbar">
            <h4>상품수정</h4>
            <div class="breadcrumb">HOME &gt; 상품관리 &gt; <b>상품수정</b></div>
        </div>

        <!-- 상품수정 폼 -->
        <!-- 컨트롤러: @PostMapping("/admin/product/modify") -->
        <form id="productForm"
              th:action="@{/admin/product/modify}"
              method="post"
              enctype="multipart/form-data">

            <!-- CSRF & PID -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="pid" th:value="${item.pPid}"/>
            <!-- 현재 pcId 보관 (카테고리 안 바꾸면 그대로 사용) -->
            <input type="hidden" id="currentPcId" th:value="${item.pcId}"/>

            <!-- ─── 상품분류 ─── -->
            <section class="block">
                <div class="block-head">
                    <strong>상품분류</strong>
                    <span class="help">카테고리를 변경하지 않으면 기존 값이 유지됩니다.</span>
                </div>

                <table class="tbl">
                    <tbody>
                    <tr>
                        <th>1차 분류</th>
                        <td>
                            <select id="cat1" name="cat1">
                                <option value="">(변경없음)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>2차 분류</th>
                        <td>
                            <select id="cat2" name="cat2" disabled>
                                <option value="">(변경없음)</option>
                            </select>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <!-- ─── 기본정보 ─── -->
            <section class="block">
                <div class="block-head">
                    <strong>기본정보</strong>
                    <span class="help">필요한 항목만 수정하세요.</span>
                </div>

                <table class="tbl">
                    <tbody>
                    <tr>
                        <th>상품명</th>
                        <td><input type="text" class="inp" name="name" th:value="${item.name}" required/></td>
                    </tr>
                    <tr>
                        <th>기본설명</th>
                        <td><input type="text" class="inp" name="summary" th:value="${item.desc}" required/></td>
                    </tr>
                    <tr>
                        <th>제조사</th>
                        <td><input type="text" class="inp" name="maker" th:value="${detail.maker}"/></td>
                    </tr>
                    <tr>
                        <th>상품금액</th>
                        <td><input type="number" class="inp" name="price" min="0" step="1" th:value="${item.price}" required/> 원</td>
                    </tr>
                    <tr>
                        <th>할인율</th>
                        <td><input type="number" class="inp" name="discountRate" min="0" max="100" step="1" th:value="${item.discount}"/> %</td>
                    </tr>
                    <tr>
                        <th>포인트</th>
                        <td><input type="number" class="inp" name="point" min="0" step="1" th:value="${item.point}"/> 원</td>
                    </tr>
                    <tr>
                        <th>재고수량</th>
                        <td><input type="number" class="inp" name="stock" min="0" step="1" th:value="${item.stockQuantity}"/> 개</td>
                    </tr>
                    <tr>
                        <th>배송비</th>
                        <td><input type="number" class="inp" name="deliveryFee" min="0" step="1" th:value="${item.deliveryPrice}"/> 원</td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <!-- ─── 상품 이미지 ─── -->
            <section class="block">
                <div class="block-head"><strong>상품 이미지</strong></div>
                <table class="tbl">
                    <tbody>
                    <tr>
                        <th>목록 이미지</th>
                        <td>
                            <div th:if="${item.imageList}">
                                현재: <a th:href="@{${item.imageList}}" th:text="${item.imageList}" target="_blank"></a>
                            </div>
                            <input type="file" accept="image/*" name="listImage"/>
                            <span class="help">선택 시 기존 이미지를 교체합니다.</span>
                        </td>
                    </tr>
                    <tr>
                        <th>메인 이미지</th>
                        <td>
                            <div th:if="${item.imageMain}">
                                현재: <a th:href="@{${item.imageMain}}" th:text="${item.imageMain}" target="_blank"></a>
                            </div>
                            <input type="file" accept="image/*" name="mainImage"/>
                        </td>
                    </tr>
                    <tr>
                        <th>상세 이미지</th>
                        <td>
                            <div th:if="${item.imageDetail}">
                                현재: <a th:href="@{${item.imageDetail}}" th:text="${item.imageDetail}" target="_blank"></a>
                            </div>
                            <input type="file" accept="image/*" name="detailImage"/>
                        </td>
                    </tr>
                    <tr>
                        <th>상세정보</th>
                        <td>
                            <div th:if="${item.detailInfo}">
                                현재: <a th:href="@{${item.detailInfo}}" th:text="${item.detailInfo}" target="_blank"></a>
                            </div>
                            <input type="file" accept="image/*" name="infoImage"/>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <!-- ─── 상품 선택정보 ─── -->
            <section class="block">
                <div class="block-head">
                    <strong>상품 선택정보</strong>
                    <span class="help">옵션을 다시 입력하면 전체가 교체됩니다. 필요 없으면 비워두세요.</span>
                </div>

                <table class="tbl" id="optionTable">
                    <tbody>
                    <tr>
                        <th>옵션1</th>
                        <td>
                            <input type="text" placeholder="옵션명 입력" class="inp" name="options[0].name"/>
                            <input type="text" placeholder="옵션 항목(콤마로 구분)" class="inp" name="options[0].items"/>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div class="btn-area" style="text-align:left; margin-top:8px;">
                    <button type="button" class="btn btn-primary" id="addOption">옵션 추가</button>
                </div>
            </section>

            <!-- ─── 상품정보 제공고시 ─── -->
            <section class="block">
                <div class="block-head">
                    <strong>상품정보 제공고시</strong>
                </div>

                <table class="tbl">
                    <tbody>
                    <tr>
                        <th>상품명 태그</th>
                        <td><input type="text" class="inp" name="notice.tag" th:value="${detail.state}" placeholder="예: 새상품"/></td>
                    </tr>
                    <tr>
                        <th>부제/연세여부</th>
                        <td><input type="text" class="inp" name="notice.taxType" th:value="${detail.tax}" placeholder="예: 과세상품"/></td>
                    </tr>
                    <tr>
                        <th>영수증 발행</th>
                        <td><input type="text" class="inp" name="notice.receipt" th:value="${detail.receipt}" placeholder="예: 발행가능 - 신용카드전표"/></td>
                    </tr>
                    <tr>
                        <th>사업자 구분</th>
                        <td><input type="text" class="inp" name="notice.bizType" th:value="${detail.sellerType}" placeholder="예: 사업자판매자"/></td>
                    </tr>
                    <tr>
                        <th>원산지</th>
                        <td><input type="text" class="inp" name="notice.origin" th:value="${detail.origin}" placeholder="예: 국내산"/></td>
                    </tr>
                    <tr>
                        <th>제조자/수입국</th>
                        <td><input type="text" class="inp" name="notice.maker" th:value="${detail.maker}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>제조국</th>
                        <td><input type="text" class="inp" name="notice.country" th:value="${detail.country}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>취급시주의사항</th>
                        <td><input type="text" class="inp" name="notice.caution" th:value="${detail.care}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>제조연월</th>
                        <td><input type="text" class="inp" name="notice.mfgDate" th:value="${detail.manufDate}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>품질보증기준</th>
                        <td><input type="text" class="inp" name="notice.warranty" th:value="${detail.warranty}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>A/S 책임자</th>
                        <td><input type="text" class="inp" name="notice.asManager" th:value="${detail.asManager}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    <tr>
                        <th>전화번호</th>
                        <td><input type="text" class="inp" name="notice.phone" th:value="${detail.phone}" placeholder="상세정보 직접 입력"/></td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <!-- 버튼 -->
            <div class="btn-area">
                <a th:href="@{/admin/product/list}" class="btn btn-delete">취소</a>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>

    <!-- 스크립트 -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            const API_BASE = /*[[@{/admin/product/categories}]]*/ "";

            // ===== 옵션 동적 추가 =====
            const optionTable = document.getElementById("optionTable");
            const addBtn = document.getElementById("addOption");
            let optionCount = optionTable.tBodies[0].rows.length;

            function renameOptionInputs() {
                const rows = optionTable.tBodies[0].rows;
                for (let i = 0; i < rows.length; i++) {
                    const inputs = rows[i].querySelectorAll("input.inp");
                    if (inputs[0]) inputs[0].setAttribute("name", `options[${i}].name`);
                    if (inputs[1]) inputs[1].setAttribute("name", `options[${i}].items`);
                    const th = rows[i].querySelector("th");
                    if (th) th.textContent = `옵션${i + 1}`;
                }
            }

            addBtn.addEventListener("click", () => {
                const newRow = optionTable.tBodies[0].insertRow();
                const th = document.createElement("th");
                th.textContent = `옵션${optionCount + 1}`;
                newRow.appendChild(th);

                const td = document.createElement("td");
                td.innerHTML = `
          <input type="text" class="inp" placeholder="옵션명 입력">
          <input type="text" class="inp" placeholder="옵션 항목(콤마로 구분)">
          <button type="button" class="btn btn-delete btn-sm removeOption">삭제</button>
        `;
                newRow.appendChild(td);

                td.querySelector(".removeOption").addEventListener("click", () => {
                    newRow.remove();
                    optionCount = optionTable.tBodies[0].rows.length;
                    renameOptionInputs();
                });

                optionCount = optionTable.tBodies[0].rows.length;
                renameOptionInputs();
            });

            // ===== 카테고리 로딩 =====
            const cat1 = document.getElementById("cat1");
            const cat2 = document.getElementById("cat2");
            const currentPcId = document.getElementById("currentPcId")?.value || "";

            function resetSelect(sel, placeholder) {
                sel.innerHTML = "";
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = placeholder;
                sel.appendChild(opt);
            }

            async function fetchJson(url) {
                const res = await fetch(url, { credentials: "same-origin" });
                if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
                const ct = res.headers.get("content-type") || "";
                if (!ct.includes("application/json")) throw new Error("JSON이 아닌 응답 수신");
                return res.json();
            }

            async function loadLevel1() {
                resetSelect(cat1, "(변경없음)");
                resetSelect(cat2, "(변경없음)");
                cat2.disabled = true;
                try {
                    const list = await fetchJson(`${API_BASE}/level1`);
                    list.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c.pcId;
                        opt.textContent = c.pcName;
                        cat1.appendChild(opt);
                    });
                } catch (e) {
                    console.error(e);
                    alert("1차 카테고리 로딩 실패: " + e.message);
                }
            }

            async function loadLevel2(parentId) {
                resetSelect(cat2, "(변경없음)");
                cat2.disabled = true;
                if (!parentId) return;
                try {
                    const list = await fetchJson(`${API_BASE}/level2?parentId=${encodeURIComponent(parentId)}`);
                    list.forEach(c => {
                        const opt = document.createElement("option");
                        opt.value = c.pcId;
                        opt.textContent = c.pcName;
                        cat2.appendChild(opt);
                    });
                    cat2.disabled = false;
                } catch (e) {
                    console.error(e);
                    alert("2차 카테고리 로딩 실패: " + e.message);
                }
            }

            cat1.addEventListener("change", e => loadLevel2(e.target.value));
            loadLevel1();

            // ===== 폼 유효성 & 카테고리 유지 처리 =====
            const form = document.getElementById("productForm");
            form.addEventListener("submit", (e) => {
                const price = form.querySelector('input[name="price"]');
                const discount = form.querySelector('input[name="discountRate"]');

                if (price && Number(price.value) < 0) {
                    e.preventDefault();
                    alert("상품금액은 0 이상이어야 합니다.");
                    return;
                }
                if (discount && discount.value !== "" && (Number(discount.value) < 0 || Number(discount.value) > 100)) {
                    e.preventDefault();
                    alert("할인율은 0~100 사이로 입력하세요.");
                    return;
                }

                // 카테고리를 변경하지 않았다면 기존 pcId를 cat2로 넣어서 보냄
                if (!cat1.value && !cat2.value && currentPcId) {
                    const hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "cat2";
                    hidden.value = currentPcId;
                    form.appendChild(hidden);
                }
            });
        });
    </script>
</th:block>
