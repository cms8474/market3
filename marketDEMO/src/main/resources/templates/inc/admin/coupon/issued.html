<th:block th:fragment="content">
    <link rel="stylesheet" href="/css/admin/coupon-status.css">
    <link rel="stylesheet" href="/css/admin/modal.css">

    <!-- ■■■■■ 메인컨텐츠 시작 ■■■■■ -->
    <div class="page">
        <div class="topbar">
            <h4>쿠폰발급현황</h4>
            <div class="breadcrumb">HOME &gt; 쿠폰관리 &gt; <b>쿠폰발급현황</b></div>
        </div>

        <!-- 검색 -->
        <form class="search-row" th:action="@{/admin/coupon/issued}" method="get">
            <select name="searchType" id="searchType">
                <option th:value="poNo"   th:selected="${req.searchType}=='poNo'">발급번호</option>
                <option th:value="cId"    th:selected="${req.searchType}=='cId'">쿠폰번호</option>
                <option th:value="cName"  th:selected="${req.searchType}=='cName'">쿠폰명</option>
                <option th:value="userId" th:selected="${req.searchType}=='userId'">사용자</option>
            </select>
            <input type="text" name="keyword" th:value="${req.keyword}" placeholder="검색어 입력">
            <button class="btn" type="submit">검색</button>
        </form>

        <!-- 목록 (발급현황 전용 컬럼) -->
        <table>
            <thead>
            <tr>
                <th>발급번호</th>
                <th>쿠폰번호</th>
                <th>쿠폰종류</th>
                <th>쿠폰명</th>
                <th>사용자</th>
                <th>상태</th>
                <th>사용일</th>
                <th>관리</th>

            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${page.dtoList}"
                th:with="st=${r.status != null ? #strings.trim(r.status) : ''}">
                <!-- 발급번호 -->
                <td class="coupon-link">
                    <a th:href="@{/admin/coupon/issued(poNo=${r.poNo}, pg=${req.pg}, size=${req.size}, searchType=${req.searchType}, keyword=${req.keyword})}"
                       th:text="${r.poNo}">PO000000</a>
                </td>

                <!-- 쿠폰번호(상세 이동) -->
                <td>
                    <a th:href="@{/admin/coupon/detail(cId=${r.cId})}"
                       th:text="${r.cId}">C000000</a>
                </td>

                <td th:text="${r.ctType}">배송비</td>
                <td th:text="${r.cName}">쿠폰명</td>
                <td th:text="${r.userId}">user01</td>

                <td class="coupon-status" th:text="${r.status}">사용가능</td>

                <td class="center"
                    th:text="${r.useDay != null ? #temporals.format(r.useDay,'yyyy-MM-dd HH:mm') : '-'}">-</td>

                <!--  관리 -->
                <td class="center">
                    <!-- 상태가 '사용가능'일 때만 중단 버튼 -->
                    <a href="#"
                       class="btn-mini stop-issue"
                       th:if="${#strings.equalsIgnoreCase(st,'사용가능')}"
                       th:attr="data-po-no=${r.poNo}">중단</a>

                    <!-- 그 외엔 중단됨 표시 -->
                    <span class="text-gray"
                          th:if="${!#strings.equalsIgnoreCase(st,'사용가능')}">중단됨</span>
                </td>
            </tr>

            <!-- 비어있을 때 -->
            <tr th:if="${#lists.isEmpty(page.dtoList)}">
                <td colspan="8" class="center">조회된 발급내역이 없습니다.</td>
            </tr>

            </tbody>
        </table>

        <!-- 페이징 -->
        <div class="pagination-wrap" th:if="${page.total > 0}">
            <div class="pagination">
                <a th:if="${page.prev}"
                   th:href="@{/admin/coupon/issued(pg=${page.start-1}, size=${req.size}, searchType=${req.searchType}, keyword=${req.keyword})}">이전</a>

                <a th:each="i : ${#numbers.sequence(page.start, page.end)}"
                   th:classappend="${i==req.pg} ? 'is-active'"
                   th:text="${i}"
                   th:href="@{/admin/coupon/issued(pg=${i}, size=${req.size}, searchType=${req.searchType}, keyword=${req.keyword})}">1</a>

                <a th:if="${page.next}"
                   th:href="@{/admin/coupon/issued(pg=${page.end+1}, size=${req.size}, searchType=${req.searchType}, keyword=${req.keyword})}">다음</a>
            </div>
        </div>
    </div>

    <!-- 상세 모달 (발급 단건 확인용 - 필요시 AJAX로 채우기) -->
    <div id="DetailModal" class="modal" aria-hidden="true">
        <div class="modal__backdrop" data-close="true"></div>
        <div class="modal__dialog order-detail" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
            <div class="modal__header">
                <h5 id="detailTitle">발급 상세</h5>
                <div class="coupon-no"><span id="od-poNo">—</span></div>
                <button type="button" class="modal__close" data-close="true" aria-label="닫기">×</button>
            </div>
            <div class="modal__body">
                <section class="od-section">
                    <table class="od-info-table">
                        <tbody>
                        <tr><th>발급번호</th><td id="m-poNo">-</td></tr>
                        <tr><th>쿠폰번호</th><td id="m-cId">-</td></tr>
                        <tr><th>쿠폰종류</th><td id="m-ctType">-</td></tr>
                        <tr><th>발급처</th><td id="m-issuer">-</td></tr>
                        <tr><th>사용여부</th><td id="m-status">-</td></tr>
                        <tr><th>발급대상</th><td id="m-userId">-</td></tr>
                        <tr><th>쿠폰명</th><td id="m-cName">-</td></tr>
                        <tr><th>혜택</th><td id="m-benefit">-</td></tr>
                        <tr><th>사용일</th><td id="m-useDay">-</td></tr>
                        </tbody>

                    </table>
                </section>
            </div>
        </div>
    </div>

    <!-- □□□□□ 메인컨텐츠 종료 □□□□□ -->
    <script th:src="@{/js/modal.js}"></script>
    <script>
        // 상태 색상 표시
        document.querySelectorAll('td.coupon-status').forEach(el => {
            const t = el.textContent.trim();
            if (t === '사용가능') el.classList.add('coupon-status--active');
            else if (t === '사용완료' || t === '만료') el.classList.add('coupon-status--closed');
        });

    </script>

    <script>
        // 우선 존재하는 키를 순서대로 선택
        const pick = (obj, ...keys) => {
            for (const k of keys) {
                const v = obj?.[k];
                if (v !== undefined && v !== null && v !== '') return v;
            }
            return null;
        };

        // yyyy-MM-dd HH:mm 으로 포맷
        const fmtDateTime = iso => {
            if (!iso) return '-';
            const d = new Date(iso);
            if (isNaN(d)) return iso;
            const p = n => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
        };

        document.querySelectorAll('.coupon-link a').forEach(a=>{
            a.addEventListener('click', async e=>{
                e.preventDefault();
                const poNo = a.textContent.trim();

                try {
                    const res = await fetch(`/admin/coupon/issued/detail?poNo=${encodeURIComponent(poNo)}`);
                    if (!res.ok) throw new Error('조회 실패');
                    const { ok, data, msg } = await res.json();
                    if (!ok) throw new Error(msg || '조회 실패');

                    // 응답 예시 키: poNo, ctType, userId, status, useDay, issuerUid, issuerName, cname, cid, ctext
                    const poNoV   = pick(data, 'poNo');
                    const cIdV    = pick(data, 'cId', 'cid');
                    const cNameV  = pick(data, 'cName', 'cname');
                    const cTextV  = pick(data, 'cText', 'ctext');
                    const ctTypeV = pick(data, 'ctType');
                    const userIdV = pick(data, 'userId');
                    const statusV = pick(data, 'status');
                    const useDayV = fmtDateTime(pick(data, 'useDay'));
                    const issuerV = pick(data, 'issuerName', 'issuerUid');

                    // 모달 채우기
                    document.getElementById('od-poNo').textContent   = poNoV ?? '-';
                    document.getElementById('m-poNo').textContent    = poNoV ?? '-';
                    document.getElementById('m-cId').textContent     = cIdV ?? '-';
                    document.getElementById('m-ctType').textContent  = ctTypeV ?? '-';
                    document.getElementById('m-cName').textContent   = cNameV ?? '-';
                    document.getElementById('m-userId').textContent  = userIdV ?? '-';
                    document.getElementById('m-status').textContent  = statusV ?? '-';
                    document.getElementById('m-issuer').textContent  = issuerV ?? '-';
                    document.getElementById('m-benefit').textContent = cTextV ?? '-';
                    document.getElementById('m-useDay').textContent  = useDayV ?? '-';

                    // 모달 열기
                    if (typeof openModal === 'function') openModal('DetailModal');
                    else document.getElementById('DetailModal').setAttribute('aria-hidden','false');
                } catch (err) {
                    alert(err.message || '상세 조회 중 오류가 발생했습니다.');
                }
            });
        });
    </script>
    <script>
        document.querySelectorAll('td.coupon-status').forEach(el => {
            const t = el.textContent.trim();
            if (t === '사용가능') el.classList.add('coupon-status--active');
            else if (t === '사용완료' || t === '만료' || t === '중단') el.classList.add('coupon-status--closed'); // ★ 중단 포함
        });
    </script>

    <script>
        const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        document.addEventListener("click", async (e) => {
            const btn = e.target.closest(".stop-issue");
            if (!btn) return;

            e.preventDefault();
            const poNo = btn.dataset.poNo;
            if (!poNo) return;

            if (!confirm("정말 중단하시겠습니까?")) return;

            btn.classList.add('is-loading'); btn.setAttribute('disabled','disabled');

            try {
                const resp = await fetch(`/admin/coupon/issued/stop?poNo=${encodeURIComponent(poNo)}`, {
                    method: 'POST',
                    headers: csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {}
                });
                const data = await resp.json().catch(()=>({}));

                if (resp.ok && data.ok) {
                    const row = btn.closest('tr');

                    // 상태 셀 업데이트: '중단'
                    const statusTd = row.querySelector('td.coupon-status');
                    if (statusTd) {
                        statusTd.textContent = '중단';
                        statusTd.classList.remove('coupon-status--active');
                        statusTd.classList.add('coupon-status--closed');
                    }

                    // 관리 셀: 버튼 → '중단됨'
                    btn.replaceWith(Object.assign(document.createElement('span'), {className:'text-gray', textContent:'중단됨'}));
                    alert('발급이 중단되었습니다.');
                } else {
                    alert(data.msg || '중단 처리 중 오류가 발생했습니다.');
                    btn.classList.remove('is-loading'); btn.removeAttribute('disabled');
                }
            } catch (err) {
                alert('네트워크 오류가 발생했습니다.');
                btn.classList.remove('is-loading'); btn.removeAttribute('disabled');
            }
        });
    </script>



</th:block>
